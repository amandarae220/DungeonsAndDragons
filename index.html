<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>D&D Pixel Crawler</title>

<style>
/* =========================================================
   THEME & GLOBALS
   ========================================================= */
:root{
  /* Grid size (15x13: -1 col +1 row for better mobile legibility) */
  --grid-w: 15;
  --grid-h: 13;

  /* Size system: desktop uses --cell directly (via fitScale) */
  --scale: 3;
  --cell: calc(16px * var(--scale));
  --gap:  calc(1px * var(--scale));

  --bg: #181a20;
  --panel: #13151b;
  --hud: #101218;
  --ink: #e9eef7;
  --muted: #a7b0be;
  --border: #2b2f3a;

  --accent: #7fd962;
  --info:   #7fb7ff;
  --warn:   #ffd166;
  --bad:    #ff6b6b;

  --hdr-h: 56px;

  /* HP bar text + vertical padding scale with cell size */
  --hp-font: clamp(12px, calc(var(--cell) * 0.36), 20px);
  --hp-vpad: clamp(4px,  calc(var(--cell) * 0.12), 10px);

  /* for desktop equal-thirds we still reserve a minimum for Script when computing scale */
  --side-min: 360px;
}

/* Reset-ish */
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { height:100%; }
body {
  margin:0; color:var(--ink); background:var(--bg);
  font: 15px/1.4 ui-monospace, Menlo, Monaco, "Cascadia Mono", Consolas, monospace;
  -webkit-text-size-adjust:100%;
  padding-top: calc(var(--hdr-h) + env(safe-area-inset-top));
}

/* =========================================================
   APP BAR
   ========================================================= */
.appbar{
  position:fixed; z-index:1200;
  top:env(safe-area-inset-top); left:0; right:0;
  height:var(--hdr-h);
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:8px 12px;
  background:#0f1117; border-bottom:1px solid var(--border);
}
.appbar-title{ font-weight:900; letter-spacing:.02em; }
.appbar-actions{ display:flex; gap:8px; }
.btn{
  font:inherit; color:var(--ink);
  background:#0f1117; border:1px solid var(--border);
  border-radius:10px; padding:8px 12px; cursor:pointer;
}
.btn:hover{ background:#151b24; }

/* Compact header for small phones */
@media (max-width: 600px){
  :root{ --hdr-h: 52px; }
  .appbar{ padding:6px 8px; }
  .appbar-title{ font-size:20px; line-height:1.1; }
  .appbar-actions{ gap:6px; }
  .appbar-actions .btn{
    padding:6px 8px;
    font-size:14px;
    line-height:1.15;
    white-space:nowrap;
  }
}
/* Ultra-narrow phones: stack title (row 1) and buttons (row 2) */
@media (max-width: 380px){
  :root{ --hdr-h: 92px; }
  .appbar{ flex-wrap:wrap; row-gap:6px; }
  .appbar-title{ flex:1 1 100%; font-size:20px; }
  .appbar-actions{ width:100%; justify-content:space-between; }
  .appbar-actions .btn{
    width:calc(50% - 4px);
    text-align:center;
    white-space:normal;
    line-height:1.15;
    padding:8px 10px;
  }
}

/* =========================================================
   MAIN GRID LAYOUT
   ========================================================= */
/* Desktop/laptop: EXACTLY three equal columns (each 1/3 width) */
.wrap{
  display:grid; gap:12px; padding:12px;
  grid-template-columns: 1fr 1fr 1fr;  /* ← equal thirds */
  grid-template-areas: "hud map side";
  overflow-x:hidden;
  align-items:start;
}
.panel{
  background:var(--panel); border:1px solid var(--border);
  border-radius:12px; padding:10px;
  min-width:0;
}
.hud{ grid-area:hud; background:var(--hud); }
.map{
  grid-area:map; background:#0b0d12; padding:8px;
  border:2px solid var(--border); border-radius:12px;
  image-rendering:pixelated; position:relative; overflow:hidden;
  width:100%; /* equal-third column width */
}
.side{ grid-area:side; display:flex; flex-direction:column; min-width:0; }

/* Center the pixel grid within the map column */
.grid-wrap{ width:100%; display:flex; flex-direction:column; align-items:center; }
.grid{
  display:grid;
  grid-template-columns: repeat(var(--grid-w), var(--cell));
  grid-template-rows:    repeat(var(--grid-h), var(--cell));
  gap: var(--gap);
  user-select:none; -webkit-user-select:none;
  width:max-content;
}
.cell{
  width:var(--cell); height:var(--cell);
  background:#0f1218;
  border-radius:calc(2px * var(--scale));
  box-shadow: inset 0 0 0 calc(1px * var(--scale)) #06070a;
  position:relative;
}
.wall   { background:#222733; }
.floor  { background:#171a22; }
.door   { background:#3b2b1a; }

/* HP bar — autosizes to text */
.hpbar{
  width: calc(var(--cell) * var(--grid-w) + (var(--grid-w) - 1) * var(--gap));
  height: calc(var(--hp-font) + var(--hp-vpad) * 2);
  background:#121621; border:1px solid var(--border);
  border-radius:999px; margin:0 0 8px; position:relative; overflow:hidden;
}
.hpbar-fill{
  position:absolute; inset:0 auto 0 0; width:60%;
  background:linear-gradient(90deg,#28c76f,#24a36f);
  transition: width .2s ease, background .2s ease;
}
.hpbar-text{
  position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
  font-size:var(--hp-font); font-weight:800; color:#fff; text-shadow:0 1px 0 rgba(0,0,0,.6);
}

/* Fog-of-war */
.fog-unseen{ filter:brightness(0.2) saturate(0.5); }
.fog-seen  { filter:brightness(0.55); }

/* Entities */
.player::after,.ally::after,.npc::after,.item::after,.monster::after{
  content:""; position:absolute; inset:20%; border-radius:calc(2px * var(--scale));
}
.player::after  { background:var(--warn); box-shadow:0 0 0 calc(2px * var(--scale)) rgba(0,0,0,.25); }
.ally::after    { background:#ff9bf3; }
.npc::after     { background:var(--info); }
.item::after    { background:var(--accent); }
.monster::after { background:var(--bad); }

@keyframes pulse { 0%{outline-color:#d9ff76} 50%{outline-color:transparent} 100%{outline-color:#d9ff76} }
.cursor{ outline:calc(2px * var(--scale)) solid #d9ff76; outline-offset:calc(-3px * var(--scale)); animation:pulse 1s ease-in-out infinite; }

/* =========================================================
   HUD / STATS / QUESTS
   ========================================================= */
.section-title{ color:var(--muted); font-size:12px; margin:2px 0 6px; letter-spacing:.1em; text-transform:uppercase; }
.stats-row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:8px; }
.stat-chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px;
  border-radius:999px; background:#1a1e29; border:1px solid #37425b; font-size:13px; }
.stat-chip b{ font-weight:800; opacity:.9; }

.inv{ display:flex; flex-wrap:wrap; gap:6px; }
.tag{ display:inline-flex; align-items:center; padding:6px 12px; border-radius:999px;
  background:#1a1e29; border:1px solid #37425b; color:#f4f6ff; font-size:13px; }
.tag.gold{ background:linear-gradient(180deg,#3b2d14,#2b2212); border-color:#7a5a1e; color:#ffeaa7; }
.tag.inv-item{ cursor:pointer; }
.tag.inv-item:hover{ background:#21283a; }

.quest-list .quest{ display:flex; align-items:center; gap:8px; margin:6px 0; }
.quest .qdot{ width:8px; height:8px; border-radius:50%; background:var(--info); }
.quest.completed .qdot{ background:var(--accent); }
.quest .qtitle{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.quest .qstatus{ margin-left:auto; opacity:.7; }

/* =========================================================
   SCRIPT (right)
   ========================================================= */
#sideCol{ display:flex; flex-direction:column; min-height:0; }
#logPanel{
  display:flex; flex-direction:column; min-height:0; overflow:auto; max-height:545px;
}
#log{ flex:1 1 auto; min-height:0; overflow:auto; -webkit-overflow-scrolling: touch; }

/* entry layout */
.log{ padding-bottom:6px; }
.entry{
  display:flex; gap:8px; align-items:flex-start; /* top-align */
  margin-bottom:10px;
}
/* fixed-size left square (top aligned) */
.portrait{
  width:18px; height:18px; flex:0 0 18px; min-width:18px; border-radius:3px;
  margin-top:2px;
}
/* the chip */
.bubble{
  flex:1 1 auto; min-width:0; word-break:break-word;
  padding:10px 12px; border:1px solid var(--border); border-radius:10px;
  background:#0f1117; box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
}
/* hues */
.entry.dialog .bubble { background:#141b28; border-color:#2f3b52; }  /* blue */
.entry.combat .bubble { background:#24171b; border-color:#4a2a31; }  /* red */
.entry.loot   .bubble { background:#152116; border-color:#2f3a2f; }  /* green */
.entry.system .bubble { background:#15161a; border-color:#32343f; }  /* gray */
.entry.door   .bubble { background:#2a2316; border-color:#5e4b26; }  /* amber */
#logTitle.pulse{ text-shadow:0 0 8px rgba(217,255,118,.85); }

/* =========================================================
   MOBILE TABS (shown on small screens)
   ========================================================= */
.mobile-tabs{ display:none; gap:8px; }
.mobile-tabs .tab{
  flex:1; text-align:center; padding:10px 12px; border-radius:10px;
  border:1px solid var(--border); background:#0f1117; color:#f4f6ff; font:inherit;
}
.mobile-tabs .tab.active{ background:#172234; border-color:#3b4b6b; }

/* =========================================================
   D-PAD
   ========================================================= */
#dpad{ grid-area:dpad; display:none; gap:12px; align-items:flex-start; }
.pad-arrows{ display:flex; flex-direction:column; align-items:center; gap:6px; }
.d-row{ display:flex; justify-content:center; gap:8px; }
.d-btn{
  min-width:48px; min-height:48px;
  padding:12px 14px; color:var(--ink); font:inherit;
  background:#0f1117; border:1px solid var(--border); border-radius:12px; cursor:pointer;
}
.d-big{ min-width:96px; }
.pad-actions{ display:flex; flex-direction:column; gap:8px; }
.act-btn{
  min-width:164px; min-height:48px; padding:10px 12px;
  color:var(--ink); background:#0f1117; border:1px solid var(--border); border-radius:12px;
  display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;
}
.act-btn small{ color:var(--muted); font-size:12px; margin-top:2px; }

/* --- D-PAD tap reliability (iOS smart-zoom / hit-slop) --- */
#dpad, #dpad .d-btn, #dpad .act-btn{
  touch-action: manipulation;
  -webkit-user-select: none; user-select: none;
}
#dpad .d-btn, #dpad .act-btn{
  font-size:16px; line-height:1.1; position:relative;
}
#dpad .d-btn::after, #dpad .act-btn::after{
  content:""; position:absolute; inset:-10px; /* expand tap target */
}

/* =========================================================
   BANNERS
   ========================================================= */
.banners{
  position:fixed; left:50%; transform:translateX(-50%);
  top: calc(env(safe-area-inset-top) + var(--hdr-h) + 8px);
  z-index:2000; width:min(92vw,640px); display:grid; gap:8px; pointer-events:none;
}
.banner{
  pointer-events:auto; display:flex; gap:10px; align-items:flex-start;
  background:#0f1117; border:1px solid var(--border); border-radius:12px; padding:8px 12px;
  box-shadow:0 6px 16px rgba(0,0,0,.35);
}
.banner .dot{ width:10px; height:10px; border-radius:50%; margin-top:4px; }
.banner .txt{ font-size:13px; line-height:1.25; }
.banner .close{ margin-left:auto; background:transparent; border:0; color:#999; cursor:pointer; }
.banner.dialog{ border-color:#2f3b52; } .banner.dialog .dot{ background:var(--info); }
.banner.combat{ border-color:#4a2a31; } .banner.combat .dot{ background:var(--bad); }
.banner.loot{ border-color:#2f3a2f; }   .banner.loot .dot{ background:var(--accent); }

/* =========================================================
   MODALS
   ========================================================= */
.overlay{
  position:fixed; inset:0; z-index:3000; display:none;
  align-items:center; justify-content:center; background:rgba(0,0,0,.55);
  padding:20px; backdrop-filter: blur(2px);
}
.overlay.show{ display:flex; }
.overlay .card{
  width:min(92vw,680px); max-height:80vh; overflow:auto;
  background:#0f1117; border:1px solid var(--border); border-radius:14px; padding:16px;
}
.overlay .choices{ display:grid; gap:8px; margin-top:8px; }
.choice-btn{
  text-align:left; padding:10px 12px; border:1px solid var(--border); border-radius:10px;
  background:#151b24; color:#e9eef7; cursor:pointer;
}
.choice-btn:hover{ background:#192132; }
.overlay .actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:12px; }

/* Instructions accordion */
details.accordion{border:1px solid var(--border);border-radius:10px;background:#0f1117;margin-top:10px}
details.accordion>summary{list-style:none;cursor:pointer;padding:10px 12px;font-weight:600;color:#f4f6ff}
details.accordion[open]>summary{border-bottom:1px solid var(--border)}
.accordion-body{padding:10px 12px;color:#d7d9e0;font-size:13px;line-height:1.35}

/* =========================================================
   RESPONSIVE: Phones Portrait
   ========================================================= */
@media (max-width: 900px) and (orientation: portrait){
  .wrap{
    grid-template-columns: minmax(0,1fr);
    grid-template-areas:
      "map"
      "dpad"
      "side";
    padding-top:6px;
  }
  #hudPanel{ display:none !important; }
  #hudPanelSide{ display:block; }
  .mobile-tabs{ display:flex; }
  #dpad{ display:flex; justify-content:center; }
  .log{ max-height:40vh; }
}

/* =========================================================
   RESPONSIVE: Phones Landscape
   Map | Side (tabs) | D-pad, with actions row under arrows
   ========================================================= */
@media (orientation: landscape) and (max-height: 500px){
  :root{ --dpad-scale: .78; }
  .wrap{
    height: calc(100svh - var(--hdr-h));
    grid-template-columns: var(--mapW,auto) var(--sideW,320px) var(--dpadW,220px);
    grid-template-areas: "map side dpad";
    align-items:stretch; gap:8px; padding:6px;
  }
  #hudPanel{ display:none !important; }
  #hudPanelSide{ display:block; }
  .mobile-tabs{ display:flex; margin-bottom:8px; }

  /* Keep script panel self-contained & scrollable */
  #sideCol{ display:flex; flex-direction:column; min-height:0; }
  #logPanel{ display:flex; flex-direction:column; min-height:0; height:100%; }
  #log{ flex:1; min-height:0; overflow:auto; }

  #dpad{
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    transform:scale(var(--dpad-scale)); transform-origin:center;
  }
  .pad-arrows{ margin-bottom:8px; }
  .pad-actions{
    display:flex; flex-direction:row; flex-wrap:nowrap; gap:8px;
    align-items:center; justify-content:center; width:100%;
  }
  .act-btn{ min-width:0; padding:8px 10px; min-height:40px; font-size:16px; flex:0 1 33%; }
  .act-btn small{ font-size:11px; }
  .d-btn{ padding:8px 10px; min-width:40px; min-height:40px; font-size:16px; }
  .d-big{ min-width:72px; }

  .map{ align-self:stretch; height:100%; width:auto; max-width:none; --gap:1px; }
  .hpbar{ width: calc(var(--cell)*var(--grid-w) + (var(--grid-w) - 1)*var(--gap)); margin:0 0 8px; }
}

/* =========================================================
   DESKTOP/LAPTOP: Equal heights for the three columns
   ========================================================= */
@media (min-width: 901px){
  .wrap{
    align-items: stretch;
    min-height: calc(100svh - var(--hdr-h) - 24px);
  }
  #hudPanel, .map, #logPanel{ height: 100%; }
  #logPanel{ display:flex; flex-direction:column; min-height:0; }
  #log{ flex:1; min-height:0; overflow:auto; max-height:unset; }
  #hudPanel{ display:flex; flex-direction:column; overflow:auto; min-height:0; }
}
</style>
</head>

<body>
<header class="appbar">
  <div class="appbar-title">D&D Pixel Crawler</div>
  <div class="appbar-actions">
    <button id="soundBtn" class="btn">🔊 Sound: On</button>
    <button id="musicBtn" class="btn">🎵 Music: On</button>
  </div>
</header>

<!-- Top notifications -->
<div id="banners" class="banners" aria-live="polite" aria-atomic="true"></div>

<div class="wrap">
  <!-- LEFT: HUD -->
  <div id="hudPanel" class="panel hud">
    <h3 class="section-title">Hero</h3>
    <div id="stats" class="stats-row"></div>

    <h3 class="section-title" style="margin-top:10px;">Inventory</h3>
    <div id="inventory" class="inv"></div>

    <h3 class="section-title" style="margin-top:10px;">Quests</h3>
    <div id="quests" class="quest-list"></div>

    <div style="margin-top:8px"><button id="codexBtn" class="btn">📖 Codex</button></div>

    <details class="accordion" style="margin-top:10px">
      <summary>Instructions</summary>
      <div class="accordion-body">
        <strong>Move:</strong> Arrow Keys / WASD, swipe, or D-pad.<br/>
        <strong>E</strong> talk/use • <strong>Space</strong> pick up • <strong>F</strong> fight (choose action) • <strong>H</strong> heal.<br/>
        Tap a potion in your Bag to heal outside combat.
      </div>
    </details>
  </div>

  <!-- CENTER: MAP -->
  <div class="map" aria-label="Map">
    <div class="grid-wrap">
      <div class="hpbar"><div id="hpfill" class="hpbar-fill"></div><div id="hptext" class="hpbar-text">HP 10/10</div></div>
      <div id="grid" class="grid" aria-label="Dungeon grid"></div>
    </div>
  </div>

  <!-- RIGHT: SCRIPT (and HUD clone for mobile tabs) -->
  <div class="side" id="sideCol">
    <div id="mobileTabs" class="mobile-tabs" role="tablist" aria-label="Panels">
      <button class="tab active" data-tab="log" role="tab" aria-selected="true" aria-controls="logPanel">Script</button>
      <button class="tab" data-tab="bag" role="tab" aria-selected="false" aria-controls="hudPanelSide">Bag</button>
    </div>

    <div id="logPanel" class="panel">
      <h3 id="logTitle" class="section-title">Script</h3>
      <div id="log" class="log"></div>
    </div>

    <!-- Hidden on desktop; shown on mobile via tabs -->
    <div id="hudPanelSide" class="panel hud" style="display:none">
      <h3 class="section-title">Hero</h3>
      <div id="stats_s" class="stats-row"></div>

      <h3 class="section-title" style="margin-top:10px;">Inventory</h3>
      <div id="inventory_s" class="inv"></div>

      <h3 class="section-title" style="margin-top:10px;">Quests</h3>
      <div id="quests_s" class="quest-list"></div>

      <div style="margin-top:8px"><button id="codexBtn_s" class="btn">📖 Codex</button></div>
    </div>
  </div>

  <!-- D-PAD (used in mobile landscape; hidden otherwise) -->
  <div id="dpad" aria-hidden="true">
    <div class="pad-arrows">
      <div class="d-row"><button class="d-btn" data-a="up" aria-label="Up">▲</button></div>
      <div class="d-row">
        <button class="d-btn" data-a="left" aria-label="Left">◀</button>
        <button class="d-btn d-big" data-a="use" aria-label="Use">Use (E)</button>
        <button class="d-btn" data-a="right" aria-label="Right">▶</button>
      </div>
      <div class="d-row"><button class="d-btn" data-a="down" aria-label="Down">▼</button></div>
    </div>
    <div class="pad-actions">
      <button class="act-btn" data-a="fight">Fight <small>(F)</small></button>
      <button class="act-btn" data-a="pick">Pick Up <small>(Space)</small></button>
      <button class="act-btn" data-a="heal">Heal <small>(H)</small></button>
    </div>
  </div>
</div>

<!-- DIALOG MODAL -->
<div id="dialog" class="overlay" role="dialog" aria-modal="true">
  <div class="card">
    <h2 id="dialog-title">Conversation</h2>
    <div id="dialog-text" class="bubble" style="margin:8px 0"></div>
    <div id="dialog-choices" class="choices"></div>
    <div class="actions"><button id="dialog-leave" class="btn">Close</button></div>
  </div>
</div>

<!-- LEVEL UP MODAL -->
<div id="lvlup" class="overlay" role="dialog" aria-modal="true">
  <div class="card">
    <h2>Level Up!</h2>
    <p id="lvlup-details"></p>
    <div class="actions"><button id="lvlup-continue" class="btn">Continue →</button></div>
  </div>
</div>

<!-- VICTORY MODAL -->
<div id="victory" class="overlay" role="dialog" aria-modal="true">
  <div class="card">
    <h2>🏆 Victory!</h2>
    <p id="victory-details">You defeated the Budget Lich!</p>
    <div class="actions">
      <button id="vict-stay" class="btn">Keep Exploring</button>
      <button id="vict-replay" class="btn">Replay (New Run)</button>
    </div>
  </div>
</div>

<!-- Music (YouTube) -->
<div id="yt-player" aria-hidden="true" style="position:absolute;left:-9999px;top:-9999px;width:1px;height:1px"></div>
<script src="https://www.youtube.com/iframe_api"></script>

<script>
/* =========================================================
   UTILITIES & STATE
   ========================================================= */
const W=15,H=13;
const key=(x,y)=>`${x},${y}`;
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
const rand=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const withSign=n=>(n>=0?"+":"")+n;
const escapeHTML=s=>String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
function vib(ms=30){ if(navigator.vibrate) try{navigator.vibrate(ms)}catch(e){} }

/* --- Quip engine (fun D&D-ish lines) --- */
const pick = (arr)=>arr[Math.floor(Math.random()*arr.length)];
const QUIP = {
  wall: [
    "You bonk the wall. No damage, but your pride fails its Dex save.",
    "Ouch. That’s a natural 1 on ‘door detection’.",
    "The wall remains undefeated. You, however, are very brave."
  ],
  move: [
    "Your boots squeak like a goblin violin.",
    "You stride forth, heroically… at walking speed.",
    "Your steps echo like dice in a tower."
  ],
  miss: [
    "You swing, crit the atmosphere, and deal 12 bludgeoning to your dignity.",
    "Your sword whooshes majestically past everything important.",
    "That was a warning swing. For morale. Theirs."
  ],
  hit: [
    "Solid hit! Somewhere, a rules lawyer nods in approval.",
    "Nice! That’ll leave a mark on the encounter budget.",
    "Direct hit! The DM sighs and erases HP."
  ],
  crit: [
    "CRIT! Bards will write a sea shanty about that one.",
    "Natural 20! You gain inspiration* (*emotional only).",
    "Critical! Even the dice are impressed."
  ],
  enemyMiss: [
    "The monster whiffs like a bard throwing a javelin.",
    "They miss! Your AC politely declines the attack.",
    "The blow glances off your plot armor."
  ],
  heal: [
    "You feel better. Placebo? Maybe. Effective? Also yes.",
    "Glug glug! You regain hit points and questionable aftertaste.",
    "A long sip, a short rest for the soul."
  ],
  loot: [
    "Shiny acquired. The economy quivers.",
    "Loot secured! Try not to read the cursed runes.",
    "Your backpack groans in approval."
  ]
};

const logEl=document.getElementById('log'), logTitle=document.getElementById('logTitle');

const state={
  level:1, hpMax:10, hp:10, ac:12, str:+2, dex:+1, atk:+4, cha:+1,
  pos:{x:2,y:2}, gold:0,
  inventory:[{id:'potion',name:'Healing Potion',qty:1,type:'potion'}],
  codex:[], ally:null,
  allyPos: null,        // follower position on the map
  musicOn:true, soundOn:true,
  room:'level1', seen:{},
  quests:[{id:'goblin',title:'Defeat the Goblin',status:'active'}],
  monstersDefeated:0,
  profSocial:2,  // proficiency bonus applied to social checks
  flags:{ bridgeCleared:false, pagesCollected:0, lichDefeated:false },
  aggroCooldown: 0,     // aggro spam control
  activeEnemyKey: null  // current targeted foe for action picker
};

/* =========================================================
   QUEST / LEVEL GATING HELPERS
   ========================================================= */
function ensureQuest(id, title){
  if(!state.quests.find(q=>q.id===id)){
    state.quests.push({id, title, status:'active'});
    renderQuests();
  }
}
function hasQuestDone(id){
  const q = state.quests.find(q=>q.id===id);
  return !!q && q.status === 'completed';
}
function isLevelComplete(roomId){
  if(roomId === 'level1') return hasQuestDone('goblin');              // beat red goblin
  if(roomId === 'level2') return hasQuestDone('ogre');                // beat ogre
  if(roomId === 'level3') return state.flags.bridgeCleared === true;  // resolved bridge
  if(roomId === 'level4') return (state.flags.pagesCollected || 0) >= 3; // got 3 pages
  if(roomId === 'level5') return state.flags.lichDefeated === true;   // beat lich
  return true;
}

/* =========================================================
   SOCIAL CHECK HELPERS
   ========================================================= */
function rollD20(){ return Math.floor(Math.random()*20)+1; }
function rollWithAdvantage(){ return Math.max(rollD20(), rollD20()); }

function skillCheck(kind, { dc, advantage=false }){
  let mod = 0;
  if (kind === 'intimidation') mod = state.str + state.profSocial;   // STR-based vibe
  if (kind === 'persuasion')   mod = state.cha + state.profSocial;   // CHA
  if (kind === 'deception')    mod = state.cha + state.profSocial;   // CHA

  const r = advantage ? rollWithAdvantage() : rollD20();
  const total = r + mod;
  const ok = total >= dc;

  banner(ok ? 'dialog' : 'combat',
    `${kind.toUpperCase()}: d20 ${advantage?'(adv) ':''}= ${r} ${withSign(mod)} → ${total} vs DC ${dc} ${ok? '✓ success' : '✗ fail'}`);

  return ok;
}

/* =========================================================
   ROOMS
   ========================================================= */
function level1(){
  const walls=new Set();
  for(let x=0;x<W;x++){walls.add(key(x,0));walls.add(key(x,H-1))}
  for(let y=0;y<H;y++){walls.add(key(0,y));walls.add(key(W-1,y))}
  [[4,2],[5,2],[6,2],[7,2],[7,3],[7,4],[8,5],[2,6],[3,6],[4,7],[5,7],[6,8],[2,9],[3,9],[4,9]]
    .forEach(([x,y])=>walls.add(key(x,y)));
  const doors=new Set([key(W-1,5)]); // exit to level2

  const npcs={
    /* Moved a little farther so you don't start on top of them */
    [key(4,4)]:{
      id:'sage', name:'Sage', portrait:'#7fb7ff',
      script:(say,choose)=>{
        say("Sage: Traveler, welcome. There’s a goblin to the east—red, rude, and squishy. Remove it.","dialog");
        choose([
          {
            label:"Give me a quest.",
            hint:"Main plot hook, very official.",
            action:()=>{
              say("Sage: Quill says ‘Quest accepted.’ Aim true, and don’t lick the dungeon walls.","dialog");
              ensureQuest('goblin','Defeat the Goblin');
              logEntry('loot',"Quest updated: Defeat the Goblin.");
            }
          },
          { label:"Any advice?", hint:"Pro tips & table talk.",
            action:()=>say("Sage: Roll high, eat snacks. Doors open with ‘E’, not shoulder charges.","dialog") },
          { label:"What’s my backstory again?", hint:"Lore speed-run.",
            action:()=>say("Sage: You’re Level 1, full of hope, and fiscally motivated. Classic build.","dialog") }
        ]);
      }
    },
    [key(2,8)]:{
      id:'bard', name:'Busker Bard', portrait:'#7fa7ff',
      script:(say,choose)=>{
        say("Bard: Care for a tune? It’ll raise spirits and possibly your ATK.","dialog");
        choose([
          {
            label:"Play me the song of your dice.",
            hint:"Bardic vibes.",
            action:()=>{
              say("Bard: *strums aggressively medievally*","dialog");
              logEntry('loot',"You feel inspired… and pocket a Lute Pick (+1 attack).");
              state.inventory.push({id:'lute_pick',name:'Lute Pick (+1 attack)',type:'charm'});
              state.atk += 1; renderHUD();
            }
          },
          { label:"Music off, please.", hint:"Toggle background music.",
            action:()=>{ if(state.musicOn) document.getElementById('musicBtn').click(); say("Bard: I shall rest my strings. For now.","dialog"); } },
          { label:"Keep playing!", hint:"Leave as is.", action:()=>say("Bard: Then let the vibes be legendary.","dialog") }
        ]);
      }
    }
  };

  const items={
    [key(5,4)]:{
      id:'charm', name:'Sage Charm (+1 attack)', type:'charm',
      onPick:()=>{ state.atk+=1; addCodex('Sage Charm (+1 attack)'); banner('loot',pick(QUIP.loot)+" (Sage Charm +1 ATK)"); }
    }
  };

  const monsters={
    [key(12,4)]:{
      id:'goblin', name:'Red Goblin', ac:11, hp:6, atk:+3,
      onDefeat:()=>{
        markQuestDone('goblin'); state.monstersDefeated++;
        banner('combat','The red goblin is no more! The initiative tracker breathes easier.');
        if(state.monstersDefeated>=1 && state.level===1) setTimeout(showLevelUp,350);
      }
    }
  };

  return {walls,doors,npcs,items,monsters};
}

function level2(){
  const walls=new Set();
  for(let x=0;x<W;x++){walls.add(key(x,0));walls.add(key(x,H-1))}
  for(let y=0;y<H;y++){walls.add(key(0,y));walls.add(key(W-1,y))}
  [[1,6],[2,6],[3,6],[7,3],[8,3],[9,3],[9,4],[9,5],[4,9],[5,9],[6,9],[10,8]]
    .forEach(([x,y])=>walls.add(key(x,y)));
  const doors=new Set([key(1,5), key(W-1,5)]); // left/back + right/forward to level3

  const npcs={
    [key(5,5)]:{
      id:'nyx', name:'Nyx', portrait:'#ff9bf3',
      script:(say,choose)=>{
        say("Nyx: I’m Nyx. You swing, I flank. We split the coin, you keep the glory. Deal?","dialog");
        choose([
          { label:"What do I gain?", hint:"+advantage on attacks (flanking)",
            action:()=>say("Nyx: Advantage on your strikes. Two d20s. Pick the better one. Feels like cheating; isn’t.","dialog") },
          { label:"What’s the catch?", hint:"Always a catch…",
            action:()=>say("Nyx: 50g reward? We split it. Math is the real monster.","dialog") },
          { label:"Deal. Join my party.", hint:"Enable advantage.",
            action:()=>{
              state.ally='nyx';
              const spot = freeAdjTo(state.pos.x, state.pos.y);
              state.allyPos = spot ? spot : {x:state.pos.x, y:state.pos.y};
              removeNPCById('level2','nyx');
              say("Nyx: Sweet. I’ll be on your right—dramatic lighting side.","dialog");
              banner('dialog',"Nyx joins! Flanking advantage enabled.");
              render();
            }
          },
          { label:"No thanks. Soloing for style points.", hint:"No ally.",
            action:()=>say("Nyx: Bold. If you die, call it a ‘character arc’.","dialog") }
        ]);
      }
    }
  };

  const items={ [key(9,6)]:{ id:'potion', name:'Healing Potion', type:'potion' } };
  const monsters={
    [key(11,6)]:{
      id:'ogre', name:'Grumpy Ogre', ac:13, hp:10, atk:+4,
      onDefeat:()=>{
        banner('combat','Ogre down! Nyx: “Told you teamwork slaps.”');
        if(state.ally==='nyx'){
          logEntry('dialog',"Nyx: Split the bounty? I’ll even carry the heavy narrative.");
        }
        markQuestDone('ogre'); // Level 2 complete
      }
    }
  };

  return {walls,doors,npcs,items,monsters};
}

/* -------- Level 3: Bridge social encounter -------- */
function level3(){
  const walls=new Set();
  // Border walls
  for(let x=0;x<W;x++){walls.add(key(x,0));walls.add(key(x,H-1))}
  for(let y=0;y<H;y++){walls.add(key(0,y));walls.add(key(W-1,y))}
  // Vertical barrier at x=8 (gate closed at y=5)
  for(let y=1;y<H-1;y++){ walls.add(key(8,y)); }
  // We'll "open" the gate by removing (8,5)
  const doors=new Set([ key(W-1,5) ]); // forward door to level4

  const npcs={
    [key(7,5)]:{
      id:'grozl',
      name:'Sgt. Grozl',
      portrait:'#c77f4a',
      script:(say,choose)=>{
        say("Grozl: Toll bridge. Pay the fee or convince me you’re not trouble.","dialog");
        choose([
          { label:"🗣 Persuasion (CHA) — We just need to pass.", hint:"DC 12",
            action:()=>{
              const ok = skillCheck('persuasion',{dc:12,advantage:false});
              if(ok){ say("Grozl: Hmph. Fine. Take this token and move along.","dialog"); grantBridgeClear(); }
              else { escalateToFight(); }
            }
          },
          { label:"😈 Intimidation (STR) — Move. Now.", hint:"DC 13 (advantage with Nyx)",
            action:()=>{
              const adv = state.ally === 'nyx';
              const ok = skillCheck('intimidation',{dc:13,advantage:adv});
              if(ok){ say("Grozl: ...Right. Proceed.","dialog"); grantBridgeClear(); }
              else { escalateToFight(); }
            }
          },
          { label:"🎭 Deception (CHA) — Official inspection.", hint:"DC 14",
            action:()=>{
              const ok = skillCheck('deception',{dc:14,advantage:false});
              if(ok){ say("Grozl: Paperwork checks out… somehow. Go.","dialog"); grantBridgeClear(); }
              else { escalateToFight(); }
            }
          },
          { label:"💰 Pay 10 gold", hint:"Auto pass",
            action:()=>{ if(state.gold>=10){ state.gold-=10; renderHUD(); say("Grozl: Efficient. Don’t drop the token in the river.","dialog"); grantBridgeClear(); }
                        else { say("Grozl: That’s not 10g. That’s pocket lint and optimism.","dialog"); } }
          },
          { label:"Fight me instead", hint:"Skip the talk.", action:()=>escalateToFight() }
        ]);

        function grantBridgeClear(){
          state.inventory.push({id:'bridge_token', name:'Bridge Token', type:'key'});
          renderHUD();
          banner('loot','Bridge Token acquired; gate unlocked!');
          removeNPCById('level3','grozl');
          openGateAt(8,5);                 // open the vertical barrier at the gate
          state.flags.bridgeCleared = true;
          ensureQuest('bridge','Resolve the Bridge');
          markQuestDone('bridge');
          dialogEl.classList.remove('show');
          render();
        }

        function escalateToFight(){
          say("Grozl: That’s a no. Boys?","dialog");
          const R=rooms['level3'];
          // Captain (key target)
          R.monsters[key(7,5)] = { id:'hob_capt', name:'Hobgoblin Captain', ac:13, hp:10, atk:+4,
            onDefeat:()=>{
              banner('combat','Captain defeated! The bridge guard breaks ranks.');
              openGateAt(8,5);
              state.flags.bridgeCleared = true;
              ensureQuest('bridge','Resolve the Bridge');
              markQuestDone('bridge');
            }
          };
          // Two adds (optional)
          R.monsters[key(6,5)] = { id:'gob',  name:'Goblin', ac:11, hp:5, atk:+3 };
          R.monsters[key(9,5)] = { id:'gob2', name:'Goblin', ac:11, hp:5, atk:+3 };
          removeNPCById('level3','grozl');
          dialogEl.classList.remove('show');
          banner('combat',"Negotiations collapsed. Initiative, anyone?");
          render();
        }
      }
    }
  };

  const items={}; // optional potion here
  const monsters={}; // empty until escalation

  return {walls,doors,npcs,items,monsters};
}

/* -------- Level 4: Collect 3 pages -------- */
function level4(){
  const walls=new Set();
  for(let x=0;x<W;x++){walls.add(key(x,0));walls.add(key(x,H-1))}
  for(let y=0;y<H;y++){walls.add(key(0,y));walls.add(key(W-1,y))}
  // A few shelves/obstacles
  [[3,3],[4,3],[5,3],[9,3],[10,3],[11,3],[5,7],[6,7],[7,7],[8,7]]
    .forEach(([x,y])=>walls.add(key(x,y)));

  const doors=new Set([ key(W-1,5) ]); // forward to level5

  const pagePick = (id)=>()=>{ 
    state.flags.pagesCollected = (state.flags.pagesCollected||0)+1;
    banner('loot',`Arcane Page collected (${state.flags.pagesCollected}/3)`);
    ensureQuest('pages','Collect 3 Arcane Pages');
    if(state.flags.pagesCollected>=3) markQuestDone('pages');
    renderHUD();
  };

  const npcs={};
  const items={
    [key(2,2)]:{id:'page1', name:'Arcane Page', type:'quest', onPick:pagePick('page1')},
    [key(7,5)]:{id:'page2', name:'Arcane Page', type:'quest', onPick:pagePick('page2')},
    [key(12,8)]:{id:'page3', name:'Arcane Page', type:'quest', onPick:pagePick('page3')}
  };

  const monsters={
    [key(10,6)]:{ id:'paper', name:'Paper Elemental', ac:12, hp:8, atk:+3,
      onDefeat:()=>banner('combat','The Paper Elemental confetti-fies heroically.') }
  };

  return {walls,doors,npcs,items,monsters};
}

/* -------- Level 5: Budget Lich -------- */
function level5(){
  const walls=new Set();
  for(let x=0;x<W;x++){walls.add(key(x,0));walls.add(key(x,H-1))}
  for(let y=0;y<H;y++){walls.add(key(0,y));walls.add(key(W-1,y))}
  // a few pillars
  [[5,4],[9,4],[5,8],[9,8]].forEach(([x,y])=>walls.add(key(x,y)));

  const doors=new Set(); // end of pilot; no further doors
  const npcs={};
  const items={ [key(2,2)]:{id:'potion', name:'Healing Potion', type:'potion'} };

  const monsters={
    [key(12,6)]:{
      id:'lich', name:'Budget Lich', ac:14, hp:16, atk:+5,
      onDefeat:()=>{
        state.flags.lichDefeated = true;
        ensureQuest('lich','Defeat the Budget Lich'); markQuestDone('lich');
        banner('loot','Victory! The procurement department reclaims the Budget Lich.');
        logEntry('dialog','Nyx: Can we expense this? Asking for a friend.','#ff9bf3');
        showVictory();  // ← victory modal
      }
    }
  };

  return {walls,doors,npcs,items,monsters};
}

const rooms={ level1:level1(), level2:level2(), level3:level3(), level4:level4(), level5:level5() };

/* =========================================================
   MAP HELPERS (ally, NPC removal, gates)
   ========================================================= */
function removeNPCById(roomId, npcId){
  const npcs = rooms[roomId].npcs;
  for(const k in npcs){ if(npcs[k].id === npcId){ delete npcs[k]; return; } }
}
function isBlockedForAlly(x,y){
  if(!inBounds(x,y) || isWall(x,y)) return true;
  if(state.pos.x===x && state.pos.y===y) return true; // don't stand on player
  const R = rooms[state.room];
  if(R.monsters[key(x,y)]) return true; // avoid standing on monsters
  return false;
}
function freeAdjTo(x,y){
  const dirs=[[0,1],[0,-1],[1,0],[-1,0]];
  for(const [dx,dy] of dirs){
    const nx=x+dx, ny=y+dy;
    if(!isBlockedForAlly(nx,ny)) return {x:nx,y:ny};
  }
  return null;
}
function stepTowards(from, to){
  const dx = Math.sign(to.x - from.x), dy = Math.sign(to.y - from.y);
  const tryOrder = [
    {x: from.x + dx, y: from.y}, {x: from.x, y: from.y + dy},
  ];
  for(const p of tryOrder){ if(!isBlockedForAlly(p.x,p.y)) return p; }
  return {x:from.x, y:from.y};
}
function openGateAt(x,y){
  const k = key(x,y);
  if(rooms['level3'].walls.has(k)){ rooms['level3'].walls.delete(k); render(); }
}

/* =========================================================
   LOOT HELPERS (manual drops)
   ========================================================= */
function placeItemNearby(x,y,item){
  const R = rooms[state.room];
  const spots = [[x,y],[x+1,y],[x-1,y],[x,y+1],[x,y-1]];
  for(const [ix,iy] of spots){
    const k = key(ix,iy);
    if(inBounds(ix,iy) && !isWall(ix,iy) && !R.items[k] && !(state.pos.x===ix && state.pos.y===iy)){
      R.items[k] = item; 
      return k;
    }
  }
  const k = key(x,y); R.items[k] = item;   // fallback
  return k;
}
function dropLootAt(x,y,opts={gold:10}){
  const item = {
    id: `pouch_${Date.now()}`,
    name: `Coin Pouch (${opts.gold}g)`,
    type: 'loot',
    onPick: ()=>{
      state.gold += (opts.gold || 0);
      renderHUD();
      banner('loot', `You scoop ${opts.gold} gold.`);
    }
  };
  placeItemNearby(x,y,item);
  logEntry('loot', `Loot dropped: ${item.name}.`);   // GREEN square
}

/* =========================================================
   MONSTER AGGRO HELPERS
   ========================================================= */
function chebDist(ax, ay, bx, by){ return Math.max(Math.abs(ax-bx), Math.abs(ay-by)); }

function tileOccupied(x,y){
  if(!inBounds(x,y) || isWall(x,y)) return true;
  const R = rooms[state.room];
  const k = key(x,y);
  if(R.monsters[k]) return true;
  if(R.npcs[k]) return true;
  if(state.pos.x===x && state.pos.y===y) return true;
  if(state.allyPos && state.allyPos.x===x && state.allyPos.y===y) return true;
  return false;
}

function moveMonster(oldKey, nx, ny){
  const R=rooms[state.room];
  const m=R.monsters[oldKey]; if(!m) return null;
  delete R.monsters[oldKey];
  R.monsters[key(nx,ny)] = m;
  return m;
}
function stepTowardsFree(from, to){
  const dx = Math.sign(to.x - from.x), dy = Math.sign(to.y - from.y);
  const candidates = [
    {x: from.x + dx, y: from.y}, 
    {x: from.x, y: from.y + dy}
  ];
  for(const p of candidates){ if(!tileOccupied(p.x,p.y)) return p; }
  return {x: from.x, y: from.y};
}
function monsterFirstStrike(mon){
  const mr = rollD20(), mh = mr + mon.atk;
  if(mr===20 || mh>=state.ac){
    const dmg = rand(1,4)+2;
    state.hp = Math.max(0, state.hp - dmg);
    logEntry('combat',`${mon.name} ambushes and hits you for ${dmg}.`);
    if(state.hp<=0){
      banner('combat','You fall… but the autosave fairy rewinds time.');
      state.hp = Math.ceil(state.hpMax/2);
      state.pos = {x:2,y:2}; reveal(state.pos.x,state.pos.y);
      if(state.ally && state.allyPos){
        const spot = freeAdjTo(state.pos.x, state.pos.y);
        state.allyPos = spot ? spot : {x:state.pos.x, y:state.pos.y};
      }
    }
  } else {
    logEntry('combat',`${mon.name} lunges first but misses!`);
  }
}
function checkAggro(){
  if(state.aggroCooldown>0){ state.aggroCooldown--; return; }
  const R = rooms[state.room];
  const px = state.pos.x, py = state.pos.y;

  for(const oldK in R.monsters){
    const [mx, my] = oldK.split(',').map(Number);
    const d = chebDist(mx,my,px,py);
    if(d <= 2){ // Aggro radius
      // Try to place the monster next to the player (4-cardinal)
      const adj = [[px+1,py],[px-1,py],[px,py+1],[px,py-1]];
      let dest = null;
      for(const [ax,ay] of adj){
        if(!tileOccupied(ax,ay)) { dest = {x:ax,y:ay}; break; }
      }

      let mon;
      if(dest){
        mon = moveMonster(oldK, dest.x, dest.y);
        banner('combat',`The ${mon.name} lunges into melee and swings first!`);
        state.activeEnemyKey = key(dest.x, dest.y);
        monsterFirstStrike(mon);
        state.aggroCooldown = 2;
        if(!dialogEl.classList.contains('show')) openCombatActions();
      }else{
        // step closer if possible
        const step = stepTowardsFree({x:mx,y:my},{x:px,y:py});
        if(step.x!==mx || step.y!==my){
          mon = moveMonster(oldK, step.x, step.y);
          banner('combat',`The ${mon.name} closes in!`);
          if(chebDist(step.x,step.y,px,py)===1){
            state.activeEnemyKey = key(step.x, step.y);
            monsterFirstStrike(mon);
            state.aggroCooldown = 2;
            if(!dialogEl.classList.contains('show')) openCombatActions();
          }
        }
      }
      break; // one aggro per movement
    }
  }
}

/* =========================================================
   RENDERING
   ========================================================= */
const gridEl=document.getElementById('grid'),
      hpFill=document.getElementById('hpfill'),
      hpText=document.getElementById('hptext');

function ensureSeenSet(){ if(!state.seen[state.room]) state.seen[state.room]=new Set(); }
function inBounds(x,y){ return x>=0 && y>=0 && x<W && y<H; }
function isWall(x,y){ return rooms[state.room].walls.has(key(x,y)); }
function isDoor(x,y){ return rooms[state.room].doors.has(key(x,y)); }
function entityAt(x,y){
  const R=rooms[state.room], k=key(x,y);
  if(R.monsters[k]) return {type:'monster',data:R.monsters[k]};
  if(R.npcs[k])     return {type:'npc',data:R.npcs[k]};
  if(R.items[k])    return {type:'item',data:R.items[k]};
  return null;
}
function reveal(x,y){
  ensureSeenSet(); const seen=state.seen[state.room];
  for(let yy=y-2;yy<=y+2;yy++) for(let xx=x-2;xx<=x+2;xx++) if(inBounds(xx,yy)) seen.add(key(xx,yy));
}

function render(){
  ensureSeenSet();
  gridEl.innerHTML='';
  const R=rooms[state.room];
  for(let y=0;y<H;y++){
    for(let x=0;x<W;x++){
      const c=document.createElement('div');
      c.className='cell '+(isWall(x,y)?'wall':'floor');
      const k=key(x,y);
      const e=entityAt(x,y);
      if(e){
        if(e.type==='npc') c.classList.add('npc');
        if(e.type==='item') c.classList.add('item');
        if(e.type==='monster') c.classList.add('monster');
      }
      if(isDoor(x,y)) c.classList.add('door');
      if(state.allyPos && state.allyPos.x===x && state.allyPos.y===y) c.classList.add('ally');
      if(state.pos.x===x && state.pos.y===y) c.classList.add('player','cursor');

      const seen=state.seen[state.room];
      const vis=seen.has(k);
      if(!vis) c.classList.add('fog-unseen');
      else if(!(state.pos.x===x && state.pos.y===y)) c.classList.add('fog-seen');

      gridEl.appendChild(c);
    }
  }
  updateHP(); renderHUD(); renderQuests();

  // Ensure per-level quests display when you arrive
  if(state.room==='level2') ensureQuest('ogre','Defeat the Ogre');
  if(state.room==='level3') ensureQuest('bridge','Resolve the Bridge');
  if(state.room==='level4') ensureQuest('pages','Collect 3 Arcane Pages');
  if(state.room==='level5') ensureQuest('lich','Defeat the Budget Lich');
}

function updateHP(){
  const p = Math.max(0, Math.min(1, state.hp/state.hpMax));
  hpFill.style.width = (p*100) + '%';
  hpFill.style.background = p < .34 ? '#c0392b' : 'linear-gradient(90deg,#28c76f,#24a36f)';
  hpText.textContent = `HP ${state.hp}/${state.hpMax}`;
}

/* =========================================================
   HUD (and HUD clone)
   ========================================================= */
function statsHTML(){
  return `
    <span class="stat-chip"><b>LV</b> ${state.level}</span>
    <span class="stat-chip"><b>HP</b> ${state.hp}/${state.hpMax}</span>
    <span class="stat-chip"><b>AC</b> ${state.ac}</span>
    <span class="stat-chip"><b>STR</b> ${withSign(state.str)}</span>
    <span class="stat-chip"><b>DEX</b> ${withSign(state.dex)}</span>
    <span class="stat-chip"><b>ATK</b> ${withSign(state.atk)}</span>
  `;
}
function renderHUD(){
  document.querySelectorAll('#stats,#stats_s').forEach(el=>el.innerHTML=statsHTML());

  ['inventory','inventory_s'].forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    el.innerHTML='';
    const gold=document.createElement('span'); gold.className='tag gold'; gold.innerHTML=`🟡 ${state.gold}g`; el.appendChild(gold);
    for(const it of state.inventory){
      const chip=document.createElement('button');
      chip.className='tag inv-item';
      chip.innerHTML = `${escapeHTML(it.name)}${it.qty>1?` ×${it.qty}`:''}`;
      if(it.type==='potion') chip.title='Use potion';
      if(it.type==='potion') chip.addEventListener('click',usePotion);
      el.appendChild(chip);
    }
  });
}
function renderQuests(){
  ['quests','quests_s'].forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    el.innerHTML='';
    for(const q of state.quests){
      const row=document.createElement('div'); row.className=`quest ${q.status}`;
      const dot=document.createElement('span'); dot.className='qdot';
      const title=document.createElement('span'); title.className='qtitle'; title.textContent=q.title;
      const st=document.createElement('span'); st.className='qstatus'; st.textContent=q.status;
      row.append(dot,title,st); el.appendChild(row);
    }
  });
}
function markQuestDone(id){ const q=state.quests.find(q=>q.id===id); if(q){ q.status='completed'; renderQuests(); } }

/* =========================================================
   SCRIPT LOG + BANNERS
   ========================================================= */
const MAX_LOG_ITEMS = 150;

function logEntry(type,text,portrait){
  // default portrait color by type
  if (!portrait){
    const colorByType = {
      dialog: '#7fb7ff',  // blue
      combat: '#ff6b6b',  // red
      loot:   '#7fd962',  // green
      system: '#9aa3b2',  // gray
      door:   '#ffd166'   // yellow/amber
    };
    portrait = colorByType[type] || '#9aa3b2';
  }

  const e=document.createElement('div'); e.className=`entry ${type}`;
  const p=document.createElement('div'); p.className='portrait'; p.style.background=portrait;
  const b=document.createElement('div'); b.className='bubble'; b.textContent=text;
  e.append(p,b);

  // newest at the top
  if(logEl.firstChild) logEl.insertBefore(e, logEl.firstChild); else logEl.appendChild(e);

  // pulse the header
  logTitle.classList.remove('pulse'); void logTitle.offsetWidth; logTitle.classList.add('pulse');

  // prune old entries
  while(logEl.childElementCount > MAX_LOG_ITEMS){
    logEl.removeChild(logEl.lastChild);
  }
}
function banner(type,text){
  const host=document.getElementById('banners');
  const b=document.createElement('div'); b.className=`banner ${type}`;
  b.innerHTML=`<div class="dot"></div><div class="txt">${escapeHTML(text)}</div><button class="close">✕</button>`;
  b.querySelector('.close').onclick=()=>b.remove();
  host.appendChild(b); setTimeout(()=>b.remove(), 4500);
}

/* =========================================================
   DIALOG SYSTEM
   ========================================================= */
const dialogEl=document.getElementById('dialog'),
      dialogText=document.getElementById('dialog-text'),
      dialogChoices=document.getElementById('dialog-choices');
document.getElementById('dialog-leave').onclick=()=>dialogEl.classList.remove('show');

function openDialog(title,text){
  document.getElementById('dialog-title').textContent=title||'Conversation';
  dialogText.textContent=text||'';
  dialogChoices.innerHTML='';
  dialogEl.classList.add('show');
}
function addChoice(label,hint,cb){
  const b=document.createElement('button'); b.className='choice-btn';
  b.textContent=label; if(hint) b.title=hint; b.onclick=()=>cb();
  dialogChoices.appendChild(b);
}

/* =========================================================
   COMBAT ACTION PICKER
   ========================================================= */
function findAdjacentMonsterKey(){
  const adj=[[0,0],[1,0],[-1,0],[0,1],[0,-1]];
  for(const [dx,dy] of adj){
    const k = key(state.pos.x+dx, state.pos.y+dy);
    if(rooms[state.room].monsters[k]) return k;
  }
  return null;
}
function openCombatActions(){
  // if no enemy locked, try to acquire one adjacent
  if(!state.activeEnemyKey || !rooms[state.room].monsters[state.activeEnemyKey]){
    state.activeEnemyKey = findAdjacentMonsterKey();
  }
  if(!state.activeEnemyKey){ banner('combat','No monsters in range.'); return; }

  const M = rooms[state.room].monsters[state.activeEnemyKey];
  if(!M) return;

  openDialog('Combat', `Choose your action vs ${M.name}:`);
  dialogChoices.innerHTML = '';
  addChoice('🏃‍♂️ Flee (provokes)', 'Move away; foe gets a free swing.', ()=>combatFlee());
  addChoice('👊 Unarmed Strike', 'Simple punch/slap. Lower damage.', ()=>combatAttack('unarmed'));
  addChoice('🗡 Weapon Attack', 'Your regular attack. Advantage with Nyx.', ()=>combatAttack('weapon'));
  addChoice('✨ Arcane Bolt', 'Simple spell. Reliable poke.', ()=>combatAttack('spell'));
}
function combatFlee(){
  const M = rooms[state.room].monsters[state.activeEnemyKey];
  if(!M){ dialogEl.classList.remove('show'); return; }

  // Attack of opportunity
  const mr=rollD20(), mh=mr+M.atk;
  if(mr===20 || mh>=state.ac){
    const dmg = rand(1,4)+2;
    state.hp = Math.max(0, state.hp - dmg);
    logEntry('combat', `${M.name} clips you as you flee for ${dmg}.`);
  }else{
    logEntry('combat', `${M.name} swings wide as you slip away.`);
  }

  // Step 1 tile away from the monster if possible
  const [mx,my] = state.activeEnemyKey.split(',').map(Number);
  const dx = Math.sign(state.pos.x - mx);
  const dy = Math.sign(state.pos.y - my);
  const dest = { x: clamp(state.pos.x + dx, 0, W-1), y: clamp(state.pos.y + dy, 0, H-1) };
  if(!isWall(dest.x,dest.y)){
    state.pos = dest;
    reveal(state.pos.x,state.pos.y);
  }
  dialogEl.classList.remove('show');
  render();
}
function combatAttack(kind){
  const k = state.activeEnemyKey;
  const M = rooms[state.room].monsters[k];
  if(!M){ dialogEl.classList.remove('show'); return; }

  // attack roll setup
  let adv = false, dmg = 0, hitLine = '';
  if(kind==='weapon'){
    adv = !!state.ally;                 // flanking advantage with Nyx
    dmg = rand(2,5) + state.str;       // as before
    hitLine = 'Weapon strike lands!';
  }else if(kind==='unarmed'){
    adv = false;
    dmg = Math.max(1, rand(1,2) + state.str); // small but at least 1
    hitLine = 'Unarmed strike connects!';
  }else{ // spell
    adv = false;
    dmg = rand(1,4) + 2;
    hitLine = 'Arcane bolt splashes!';
  }

  const r = adv ? rollWithAdvantage() : rollD20();
  const toHit = r + state.atk;

  if(r===20){ M.hp = 0; logEntry('combat', pick(QUIP.crit)); }
  else if(toHit >= M.ac){
    M.hp -= dmg;
    logEntry('combat', `${hitLine} d20${adv?' (adv)':''}=${r} + ATK ${state.atk} = ${toHit} vs AC ${M.ac}.`);
  }else{
    logEntry('combat', pick(QUIP.miss));
  }

  // resolve enemy or defeat
  if(M.hp <= 0){
    delete rooms[state.room].monsters[k];
    if(typeof M.onDefeat==='function') M.onDefeat();
    state.activeEnemyKey = null;

    // Drop a coin pouch at or near the monster
    const [mx,my] = k.split(',').map(Number);
    dropLootAt(mx,my,{gold:10});

    dialogEl.classList.remove('show');
    render();
    return;
  }else{
    // enemy swings back
    const mr=rollD20(), mh=mr+M.atk;
    if(mr===20 || mh>=state.ac){
      const dmg2=rand(1,4)+2; state.hp=Math.max(0,state.hp-dmg2);
      logEntry('combat',`The ${M.name} hits you for ${dmg2}.`);
      if(state.hp<=0){
        banner('combat','You fall… but the autosave fairy rewinds time.');
        state.hp=Math.ceil(state.hpMax/2); state.pos={x:2,y:2}; reveal(state.pos.x,state.pos.y);
        if(state.ally && state.allyPos){ const spot = freeAdjTo(state.pos.x, state.pos.y); state.allyPos = spot?spot:{x:state.pos.x,y:state.pos.y}; }
      }
    } else {
      logEntry('combat', pick(QUIP.enemyMiss));
    }
  }

  dialogEl.classList.remove('show');
  render();
}

/* =========================================================
   ACTIONS (movement, use, loot, fight, heal)
   ========================================================= */
function tryMove(dx,dy){
  const nx=clamp(state.pos.x+dx,0,W-1), ny=clamp(state.pos.y+dy,0,H-1);
  if(isWall(nx,ny)){ logEntry('system', pick(QUIP.wall)); return; }

  const prev = {x: state.pos.x, y: state.pos.y};
  state.pos.x=nx; state.pos.y=ny; vib(10); reveal(nx,ny);

  if(state.ally && state.allyPos){
    if(!isBlockedForAlly(prev.x, prev.y)){ state.allyPos = {x:prev.x, y:prev.y}; }
    else { state.allyPos = stepTowards(state.allyPos, prev); }
  }

  if(isDoor(nx,ny)) banner('dialog','You stand by a door. Press E to use it.');

  /* Aggro check */
  checkAggro();

  render();
}

function tryUse(){
  const {x,y}=state.pos;

  // Doors: current or adjacent
  if([key(x,y),key(x+1,y),key(x-1,y),key(x,y+1),key(x,y-1)].some(k=>rooms[state.room].doors.has(k))){

    // GATE: block room exit until current level objective is complete
    if(!isLevelComplete(state.room)){
      banner('dialog',"The door won’t budge. Finish your current objective first.");
      return;
    }

    const doorLines = [
      "Door: Speak ‘E’ and enter.",
      "Door: *creaks in Common* Welcome to consequences.",
      "Door: Warning—beyond here lies plot."
    ];
    banner('dialog', pick(doorLines));
    logEntry('door', 'You step through the door.');

    // forward in the chain
    if(state.room==='level1'){ goTo('level2',{x:1,y:5}); ensureQuest('ogre','Defeat the Ogre'); return; }
    if(state.room==='level2'){ goTo('level3',{x:1,y:5}); ensureQuest('bridge','Resolve the Bridge'); return; }
    if(state.room==='level3'){ goTo('level4',{x:1,y:5}); ensureQuest('pages','Collect 3 Arcane Pages'); return; }
    if(state.room==='level4'){ goTo('level5',{x:1,y:5}); ensureQuest('lich','Defeat the Budget Lich'); return; }

    banner('system','The door is stubborn. It probably leads back.');
  }

  // NPC talk (self or adjacent)
  for(const [cx,cy] of [[x,y],[x+1,y],[x-1,y],[x,y+1],[x,y-1]]){
    const npc=rooms[state.room].npcs[key(cx,cy)];
    if(npc){
      openDialog(npc.name,'');
      const say=(t,type='dialog')=>{ dialogText.textContent=t; logEntry(type,t,npc.portrait); };
      const choose=(arr)=>{ dialogChoices.innerHTML=''; arr.forEach(o=>addChoice(o.label,o.hint,()=>o.action())); };
      npc.script(say,choose);
      return;
    }
  }
  logEntry('system','There is nothing obvious to use here.');
}

function goTo(roomId, pos){
  state.room = roomId;
  if(!state.seen[state.room]) state.seen[state.room]=new Set();
  logEntry('system',`You enter ${roomId}.`);
  state.pos = {x:pos.x, y:pos.y}; reveal(state.pos.x,state.pos.y);
  if(state.ally && state.allyPos){
    const spot = freeAdjTo(state.pos.x, state.pos.y);
    state.allyPos = spot ? spot : {x:state.pos.x, y:state.pos.y};
  }
  render();
}

function tryPick(){
  const k=key(state.pos.x,state.pos.y);
  const it=rooms[state.room].items[k];
  if(!it){ logEntry('system','You scoop up a handful of air. Tastes like pixels.'); return; }
  delete rooms[state.room].items[k];
  const ex=state.inventory.find(i=>i.id===it.id);
  if(ex) ex.qty=(ex.qty||1)+1; else { it.qty=1; state.inventory.push(it); }
  if(typeof it.onPick==='function') it.onPick();
  logEntry('loot', `Picked up ${it.name}.`);   // GREEN square
  banner('loot', pick(QUIP.loot)+` (${it.name})`);
  renderHUD(); render();
}

function tryFight(){
  const k = findAdjacentMonsterKey();
  if(!k){ logEntry('combat', pick(QUIP.miss)); banner('combat','No monsters in range.'); return; }
  state.activeEnemyKey = k;
  openCombatActions();
}

function usePotion(){
  const p=state.inventory.find(i=>i.id==='potion'&&i.qty>0);
  if(!p){ banner('system','No potions.'); return; }
  if(state.hp>=state.hpMax){ banner('system','Already at full health.'); return; }
  p.qty--; if(p.qty<=0) state.inventory=state.inventory.filter(i=>i!==p);
  const heal=5; state.hp=Math.min(state.hpMax,state.hp+heal);
  banner('loot', pick(QUIP.heal)+` (+${heal} HP)`); renderHUD(); render();
}

/* =========================================================
   LEVEL UP
   ========================================================= */
function showLevelUp(){
  state.level+=1; state.hpMax+=5; state.ac+=1; state.hp=state.hpMax;
  document.getElementById('lvlup-details').textContent=`You reached level ${state.level}! +5 HP, +1 AC.`;
  document.getElementById('lvlup').classList.add('show');
}
document.getElementById('lvlup-continue').onclick=()=>{
  document.getElementById('lvlup').classList.remove('show');
  goTo('level2',{x:1,y:5});
  ensureQuest('ogre','Defeat the Ogre');
  banner('system','Level 2 unlocked.');
};

/* =========================================================
   VICTORY / REPLAY
   ========================================================= */
function countPotions(){
  const p=state.inventory.find(i=>i.id==='potion'); return p? (p.qty||1) : 0;
}
function showVictory(){
  const v=document.getElementById('victory');
  const allyText = state.ally ? 'Nyx' : 'None';
  document.getElementById('victory-details').textContent =
    `You defeated the Budget Lich! Summary → Level ${state.level}, Gold ${state.gold}g, Potions ${countPotions()}, Ally: ${allyText}.`;
  v.classList.add('show');
}
document.getElementById('vict-stay').onclick=()=>document.getElementById('victory').classList.remove('show');
document.getElementById('vict-replay').onclick=()=>{
  document.getElementById('victory').classList.remove('show');
  resetGame();
  banner('dialog','New run! The dungeon forgot you. Again.');
};

function resetGame(){
  // Reset state
  state.level=1; state.hpMax=10; state.hp=10; state.ac=12;
  state.str=+2; state.dex=+1; state.atk=+4; state.cha=+1;
  state.gold=0; state.inventory=[{id:'potion',name:'Healing Potion',qty:1,type:'potion'}];
  state.codex=[]; state.ally=null; state.allyPos=null;
  state.room='level1'; state.seen={}; state.monstersDefeated=0;
  state.quests=[{id:'goblin',title:'Defeat the Goblin',status:'active'}];
  state.flags={ bridgeCleared:false, pagesCollected:0, lichDefeated:false };
  state.aggroCooldown=0; state.activeEnemyKey=null;

  // Rebuild rooms (fresh)
  rooms.level1=level1(); rooms.level2=level2(); rooms.level3=level3(); rooms.level4=level4(); rooms.level5=level5();

  // Start position
  state.pos={x:2,y:2}; ensureSeenSet(); reveal(state.pos.x,state.pos.y);

  renderHUD(); renderQuests(); render(); fitScale();
  logEntry('dialog','Sage: A red fiend lurks east. End it.','#7fb7ff');
}

/* =========================================================
   CODEX
   ========================================================= */
function addCodex(e){ state.codex.push(e); logEntry('loot',`Codex updated: ${e}`); }
document.getElementById('codexBtn').onclick=()=>{ openDialog('Codex', (state.codex.length? state.codex.join('\n• '):'So empty. Talk to people, pick up shiny things.')); addChoice('Close','',()=>dialogEl.classList.remove('show')); };
document.getElementById('codexBtn_s').onclick=()=>document.getElementById('codexBtn').click();

/* =========================================================
   INPUTS
   ========================================================= */
function bindInputs(){
  window.addEventListener('keydown',e=>{
    if(document.getElementById('dialog').classList.contains('show')) return;
    switch(e.key){
      case'ArrowUp':case'w':case'W': tryMove(0,-1); break;
      case'ArrowDown':case's':case'S': tryMove(0, 1); break;
      case'ArrowLeft':case'a':case'A': tryMove(-1,0); break;
      case'ArrowRight':case'd':case'D': tryMove(1, 0); break;
      case'e':case'E': tryUse(); break;
      case' ': tryPick(); e.preventDefault(); break;
      case'f':case'F': tryFight(); break;
      case'h':case'H': usePotion(); break;
    }
  });

  /* D-PAD: pointerdown for instant response + click fallback, prevent double-tap zoom */
  const dpadEl = document.getElementById('dpad');
  let lastPressTs = 0;

  function handleDpadPress(e){
    const btn = e.target.closest('[data-a]');
    if(!btn) return;
    const now = performance.now();
    if(e.type === 'click' && now - lastPressTs < 350){ e.preventDefault(); return; }
    lastPressTs = now;

    e.preventDefault(); e.stopPropagation();
    const a = btn.dataset.a;
    if(a==='up') tryMove(0,-1);
    else if(a==='down') tryMove(0,1);
    else if(a==='left') tryMove(-1,0);
    else if(a==='right') tryMove(1,0);
    else if(a==='use') tryUse();
    else if(a==='fight') tryFight();
    else if(a==='pick') tryPick();
    else if(a==='heal') usePotion();
  }

  dpadEl.addEventListener('pointerdown', handleDpadPress);
  dpadEl.addEventListener('click', handleDpadPress);

  // Consume double-taps inside the D-pad (iOS smart-zoom workaround)
  let lastTouchTime = 0;
  dpadEl.addEventListener('touchend', (e)=>{
    const now = Date.now();
    if(now - lastTouchTime <= 300){ e.preventDefault(); }
    lastTouchTime = now;
  }, {passive:false});
}

/* =========================================================
   MOBILE TABS
   ========================================================= */
function initMobileTabs(){
  const tabs=document.getElementById('mobileTabs');
  function setTab(tab){
    const log=document.getElementById('logPanel');
    const bag=document.getElementById('hudPanelSide');
    bag.style.display = (tab==='bag') ? 'block' : 'none';
    log.style.display = (tab==='log') ? 'block' : 'none';
    [...tabs.querySelectorAll('.tab')].forEach(b=>{
      const on=b.dataset.tab===tab;
      b.classList.toggle('active', on);
      b.setAttribute('aria-selected', on?'true':'false');
    });
  }
  tabs.addEventListener('click',e=>{
    const b=e.target.closest('.tab'); if(b) setTab(b.dataset.tab);
  });
  window.addEventListener('resize',()=>setTab('log'),{passive:true});
  setTab('log');
}

/* =========================================================
   MUSIC / SOUND
   ========================================================= */
let ytPlayer;
window.onYouTubeIframeAPIReady = function(){
  ytPlayer = new YT.Player('yt-player',{
    videoId:'wScEFaoqwPM',
    playerVars:{ autoplay:1, loop:1, playlist:'wScEFaoqwPM' },
    events:{ onReady:e=>{ state.musicOn?e.target.playVideo():e.target.pauseVideo(); } }
  });
};
document.getElementById('musicBtn').onclick=()=>{
  state.musicOn=!state.musicOn;
  document.getElementById('musicBtn').textContent = state.musicOn ? '🎵 Music: On' : '🎵 Music: Off';
  if(ytPlayer && ytPlayer.getPlayerState){ state.musicOn?ytPlayer.playVideo():ytPlayer.pauseVideo(); }
};
document.getElementById('soundBtn').onclick=()=>{
  state.soundOn=!state.soundOn;
  document.getElementById('soundBtn').textContent = state.soundOn ? '🔊 Sound: On' : '🔈 Sound: Off';
};

/* =========================================================
   RESPONSIVE SIZING — container-aware fitScale()
   ========================================================= */
function fitScale(){
  const root = document.documentElement;
  const appbar = document.querySelector('.appbar');
  const wrap = document.querySelector('.wrap');

  const hpReserve = 22;        // small buffer above the HP bar
  const gap = 1;               // grid gutters at small scales

  const isLandscapePhone = window.matchMedia('(orientation: landscape) and (max-height: 500px)').matches;

  if (isLandscapePhone){
    /* ===== Phones Landscape: Map | Side | D-pad ===== */
    const vw = Math.min(window.innerWidth, document.documentElement.clientWidth);
    const vh = window.innerHeight;
    const headerH = appbar?.getBoundingClientRect().height || 56;

    const sideW = Math.max(260, Math.round(vw * 0.34));   // middle column
    const dpadW = Math.max(190, Math.round(vw * 0.26));   // right column
    const mapAvailW = vw - sideW - dpadW - 16;            // remaining for map
    const mapAvailH = vh - headerH - 10;

    const cellByW = Math.floor((mapAvailW - (W-1)*gap) / W);
    const cellByH = Math.floor((mapAvailH - hpReserve - (H-1)*gap) / H);
    const cell = Math.max(10, Math.min(64, Math.min(cellByW, cellByH)));

    root.style.setProperty('--gap', `${gap}px`);
    root.style.setProperty('--scale','1');
    root.style.setProperty('--cell', `${cell}px`);
    root.style.setProperty('--mapW', `${cell*W + gap*(W-1)}px`);
    root.style.setProperty('--sideW', `${sideW}px`);
    root.style.setProperty('--dpadW', `${dpadW}px`);
    return;
  }

  // ===== Desktop & portrait: compute from the actual map column width/height =====
  root.style.removeProperty('--mapW');
  root.style.removeProperty('--sideW');
  root.style.removeProperty('--dpadW');

  const mapOuter = document.querySelector('.map');
  const cs = getComputedStyle(mapOuter);
  const padX = parseFloat(cs.paddingLeft) + parseFloat(cs.paddingRight);
  const borderX = parseFloat(cs.borderLeftWidth) + parseFloat(cs.borderRightWidth);
  const mapAvailW = Math.max(120, mapOuter.clientWidth - padX - borderX);

  const vh = window.innerHeight;
  const headerH = appbar?.getBoundingClientRect().height || 56;
  const wrapCS = getComputedStyle(wrap);
  const padY = parseFloat(wrapCS.paddingTop) + parseFloat(wrapCS.paddingBottom);
  const mapAvailH = Math.max(160, vh - headerH - padY);

  const cellByW = Math.floor((mapAvailW - (W-1)*gap) / W);
  const cellByH = Math.floor((mapAvailH - hpReserve - (H-1)*gap) / H);
  const cell = Math.max(12, Math.min(64, Math.min(cellByW, cellByH)));

  root.style.setProperty('--gap', `${gap}px`);
  root.style.setProperty('--scale','1');
  root.style.setProperty('--cell', `${cell}px`);
}

/* Listeners so it stays dynamic */
window.addEventListener('resize', fitScale, {passive:true});
window.addEventListener('orientationchange', ()=>setTimeout(fitScale, 60), {passive:true});
const __ro = new ResizeObserver(()=>fitScale());
__ro.observe(document.body);

/* =========================================================
   BOOT
   ========================================================= */
function bootstrap(){
  ensureSeenSet(); reveal(state.pos.x,state.pos.y);
  bindInputs(); initMobileTabs();
  render(); renderHUD();
  fitScale();

  // Starter script lines (fresh, punchy)
  logEntry('dialog','Sage: A red fiend lurks east. End it.','#7fb7ff');
  logEntry('dialog','You: Give me a quest','#7fb7ff');
  banner('dialog','Welcome! Use arrows/WASD or D-pad. Press E near NPCs/doors.');
}
bootstrap();
</script>
</body>
</html>
