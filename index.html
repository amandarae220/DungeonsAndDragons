<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>D&D Pixel Crawler</title>

<style>
/* =========================================================
   THEME & GLOBALS
   ========================================================= */
:root{
  /* Grid size (15x13: -1 col +1 row for better mobile legibility) */
  --grid-w: 15;
  --grid-h: 13;

  /* Size system: desktop uses --cell directly (via fitScale) */
  --scale: 3;
  --cell: calc(16px * var(--scale));
  --gap:  calc(1px * var(--scale));

  --bg: #181a20;
  --panel: #13151b;
  --hud: #101218;
  --ink: #e9eef7;
  --muted: #a7b0be;
  --border: #2b2f3a;

  --accent: #7fd962;
  --info:   #7fb7ff;
  --warn:   #ffd166;
  --bad:    #ff6b6b;

  --hdr-h: 56px;

  /* for desktop equal-thirds we still reserve a minimum for Script when computing scale */
  --side-min: 360px;
}

/* Reset-ish */
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { height:100%; }
body {
  margin:0; color:var(--ink); background:var(--bg);
  font: 15px/1.4 ui-monospace, Menlo, Monaco, "Cascadia Mono", Consolas, monospace;
  -webkit-text-size-adjust:100%;
  padding-top: calc(var(--hdr-h) + env(safe-area-inset-top));
}

/* =========================================================
   APP BAR
   ========================================================= */
.appbar{
  position:fixed; z-index:1200;
  top:env(safe-area-inset-top); left:0; right:0;
  height:var(--hdr-h);
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:8px 12px;
  background:#0f1117; border-bottom:1px solid var(--border);
}
.appbar-title{ font-weight:900; letter-spacing:.02em; }
.appbar-actions{ display:flex; gap:8px; }
.btn{
  font:inherit; color:var(--ink);
  background:#0f1117; border:1px solid var(--border);
  border-radius:10px; padding:8px 12px; cursor:pointer;
}
.btn:hover{ background:#151b24; }

/* =========================================================
   MAIN GRID LAYOUT
   ========================================================= */
/* Desktop/laptop: EXACTLY three equal columns (each 1/3 width) */
.wrap{
  display:grid; gap:12px; padding:12px;
  grid-template-columns: 1fr 1fr 1fr;  /* â† equal thirds */
  grid-template-areas: "hud map side";
  overflow-x:hidden;
  align-items:start;
}
.panel{
  background:var(--panel); border:1px solid var(--border);
  border-radius:12px; padding:10px;
  min-width:0;
}
.hud{ grid-area:hud; background:var(--hud); }
.map{
  grid-area:map; background:#0b0d12; padding:8px;
  border:2px solid var(--border); border-radius:12px;
  image-rendering:pixelated; position:relative; overflow:hidden;
  width:100%; /* equal-third column width */
}
.side{ grid-area:side; display:flex; flex-direction:column; min-width:0; }

/* Center the pixel grid within the map column */
.grid-wrap{ width:100%; display:flex; flex-direction:column; align-items:center; }
.grid{
  display:grid;
  grid-template-columns: repeat(var(--grid-w), var(--cell));
  grid-template-rows:    repeat(var(--grid-h), var(--cell));
  gap: var(--gap);
  user-select:none; -webkit-user-select:none;
  width:max-content;
}
.cell{
  width:var(--cell); height:var(--cell);
  background:#0f1218;
  border-radius:calc(2px * var(--scale));
  box-shadow: inset 0 0 0 calc(1px * var(--scale)) #06070a;
  position:relative;
}
.wall   { background:#222733; }
.floor  { background:#171a22; }
.door   { background:#3b2b1a; }

/* HP bar */
.hpbar{
  width: calc(var(--cell)*var(--grid-w) + (var(--grid-w) - 1)*var(--gap));
  height: calc(6px * var(--scale));
  background:#121621; border:1px solid var(--border);
  border-radius:999px; margin:0 0 8px; position:relative; overflow:hidden;
}
.hpbar-fill{
  position:absolute; inset:0 auto 0 0; width:60%;
  background:linear-gradient(90deg,#28c76f,#24a36f);
  transition: width .2s ease, background .2s ease;
}
.hpbar-text{
  position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
  font-size:12px; font-weight:800; color:#fff; text-shadow:0 1px 0 rgba(0,0,0,.6);
}

/* Fog-of-war */
.fog-unseen{ filter:brightness(0.2) saturate(0.5); }
.fog-seen  { filter:brightness(0.55); }

/* Entities */
.player::after,.ally::after,.npc::after,.item::after,.monster::after{
  content:""; position:absolute; inset:20%; border-radius:calc(2px * var(--scale));
}
.player::after  { background:var(--warn); box-shadow:0 0 0 calc(2px * var(--scale)) rgba(0,0,0,.25); }
.ally::after    { background:#ff9bf3; }
.npc::after     { background:var(--info); }
.item::after    { background:var(--accent); }
.monster::after { background:var(--bad); }

@keyframes pulse { 0%{outline-color:#d9ff76} 50%{outline-color:transparent} 100%{outline-color:#d9ff76} }
.cursor{ outline:calc(2px * var(--scale)) solid #d9ff76; outline-offset:calc(-3px * var(--scale)); animation:pulse 1s ease-in-out infinite; }

/* =========================================================
   HUD / STATS / QUESTS
   ========================================================= */
.section-title{ color:var(--muted); font-size:12px; margin:2px 0 6px; letter-spacing:.1em; text-transform:uppercase; }
.stats-row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:8px; }
.stat-chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px;
  border-radius:999px; background:#1a1e29; border:1px solid #37425b; font-size:13px; }
.stat-chip b{ font-weight:800; opacity:.9; }

.inv{ display:flex; flex-wrap:wrap; gap:6px; }
.tag{ display:inline-flex; align-items:center; padding:6px 12px; border-radius:999px;
  background:#1a1e29; border:1px solid #37425b; color:#f4f6ff; font-size:13px; }
.tag.gold{ background:linear-gradient(180deg,#3b2d14,#2b2212); border-color:#7a5a1e; color:#ffeaa7; }
.tag.inv-item{ cursor:pointer; }
.tag.inv-item:hover{ background:#21283a; }

.quest-list .quest{ display:flex; align-items:center; gap:8px; margin:6px 0; }
.quest .qdot{ width:8px; height:8px; border-radius:50%; background:var(--info); }
.quest.completed .qdot{ background:var(--accent); }
.quest .qtitle{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.quest .qstatus{ margin-left:auto; opacity:.7; }

/* =========================================================
   SCRIPT (right)
   ========================================================= */
.log{ max-height: calc(var(--cell)*var(--grid-h) + 16px); overflow:auto; padding-bottom:6px; }
.entry{ display:flex; gap:8px; align-items:flex-start; margin:8px 0; }
.portrait{ width:18px; height:18px; border-radius:4px; background:#2b2f3a; image-rendering:pixelated; box-shadow:inset 0 0 0 2px #0a0b10; }
.bubble{ padding:6px 8px; border-radius:8px; background:#131a24; border:1px solid #273041; }
.entry.dialog .bubble { background:#141b28; border-color:#2f3b52; }
.entry.combat .bubble { background:#24171b; border-color:#4a2a31; }
.entry.loot   .bubble { background:#152116; border-color:#2f3a2f; }
#logTitle.pulse{ text-shadow:0 0 8px rgba(217,255,118,.85); }

/* =========================================================
   MOBILE TABS (shown on small screens)
   ========================================================= */
.mobile-tabs{ display:none; gap:8px; }
.mobile-tabs .tab{
  flex:1; text-align:center; padding:10px 12px; border-radius:10px;
  border:1px solid var(--border); background:#0f1117; color:#f4f6ff; font:inherit;
}
.mobile-tabs .tab.active{ background:#172234; border-color:#3b4b6b; }

/* =========================================================
   D-PAD
   ========================================================= */
#dpad{ grid-area:dpad; display:none; gap:12px; align-items:flex-start; }
.pad-arrows{ display:flex; flex-direction:column; align-items:center; gap:6px; }
.d-row{ display:flex; justify-content:center; gap:8px; }
.d-btn{
  min-width:48px; min-height:48px;
  padding:12px 14px; color:var(--ink); font:inherit;
  background:#0f1117; border:1px solid var(--border); border-radius:12px; cursor:pointer;
}
.d-big{ min-width:96px; }
.pad-actions{ display:flex; flex-direction:column; gap:8px; }
.act-btn{
  min-width:164px; min-height:48px; padding:10px 12px;
  color:var(--ink); background:#0f1117; border:1px solid var(--border); border-radius:12px;
  display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;
}
.act-btn small{ color:var(--muted); font-size:12px; margin-top:2px; }

/* =========================================================
   BANNERS
   ========================================================= */
.banners{
  position:fixed; left:50%; transform:translateX(-50%);
  top: calc(env(safe-area-inset-top) + var(--hdr-h) + 8px);
  z-index:2000; width:min(92vw,640px); display:grid; gap:8px; pointer-events:none;
}
.banner{
  pointer-events:auto; display:flex; gap:10px; align-items:flex-start;
  background:#0f1117; border:1px solid var(--border); border-radius:12px; padding:8px 12px;
  box-shadow:0 6px 16px rgba(0,0,0,.35);
}
.banner .dot{ width:10px; height:10px; border-radius:50%; margin-top:4px; }
.banner .txt{ font-size:13px; line-height:1.25; }
.banner .close{ margin-left:auto; background:transparent; border:0; color:#999; cursor:pointer; }
.banner.dialog{ border-color:#2f3b52; } .banner.dialog .dot{ background:var(--info); }
.banner.combat{ border-color:#4a2a31; } .banner.combat .dot{ background:var(--bad); }
.banner.loot{ border-color:#2f3a2f; }   .banner.loot .dot{ background:var(--accent); }

/* =========================================================
   MODALS
   ========================================================= */
.overlay{
  position:fixed; inset:0; z-index:3000; display:none;
  align-items:center; justify-content:center; background:rgba(0,0,0,.55);
  padding:20px; backdrop-filter: blur(2px);
}
.overlay.show{ display:flex; }
.overlay .card{
  width:min(92vw,680px); max-height:80vh; overflow:auto;
  background:#0f1117; border:1px solid var(--border); border-radius:14px; padding:16px;
}
.overlay .choices{ display:grid; gap:8px; margin-top:8px; }
.choice-btn{
  text-align:left; padding:10px 12px; border:1px solid var(--border); border-radius:10px;
  background:#151b24; color:#e9eef7; cursor:pointer;
}
.choice-btn:hover{ background:#192132; }
.overlay .actions{ display:flex; justify-content:flex-end; margin-top:12px; }

/* Instructions accordion */
details.accordion{border:1px solid var(--border);border-radius:10px;background:#0f1117;margin-top:10px}
details.accordion>summary{list-style:none;cursor:pointer;padding:10px 12px;font-weight:600;color:#f4f6ff}
details.accordion[open]>summary{border-bottom:1px solid var(--border)}
.accordion-body{padding:10px 12px;color:#d7d9e0;font-size:13px;line-height:1.35}

/* =========================================================
   RESPONSIVE: Phones Portrait
   ========================================================= */
@media (max-width: 900px) and (orientation: portrait){
  .wrap{
    grid-template-columns: minmax(0,1fr);
    grid-template-areas:
      "map"
      "dpad"
      "side";
    padding-top:6px;
  }
  #hudPanel{ display:none !important; }
  #hudPanelSide{ display:block; }
  .mobile-tabs{ display:flex; }
  #dpad{ display:flex; justify-content:center; }
  .log{ max-height:40vh; }
}

/* =========================================================
   RESPONSIVE: Phones Landscape
   Map | Side (tabs) | D-pad, with actions row under arrows
   ========================================================= */
@media (orientation: landscape) and (max-height: 500px){
  :root{ --dpad-scale: .78; }
  .wrap{
    height: calc(100svh - var(--hdr-h));
    grid-template-columns: var(--mapW,auto) var(--sideW,320px) var(--dpadW,220px);
    grid-template-areas: "map side dpad";
    align-items:stretch; gap:8px; padding:6px;
  }
  #hudPanel{ display:none !important; }
  #hudPanelSide{ display:block; }
  .mobile-tabs{ display:flex; margin-bottom:8px; }

  #dpad{
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    transform:scale(var(--dpad-scale)); transform-origin:center;
  }
  .pad-arrows{ margin-bottom:8px; }
  .pad-actions{
    display:flex; flex-direction:row; flex-wrap:nowrap; gap:8px;
    align-items:center; justify-content:center; width:100%;
  }
  .act-btn{ min-width:0; padding:8px 10px; min-height:40px; font-size:15px; flex:0 1 33%; }
  .act-btn small{ font-size:11px; }
  .d-btn{ padding:8px 10px; min-width:40px; min-height:40px; font-size:14px; }
  .d-big{ min-width:72px; }

  .map{ align-self:stretch; height:100%; width:auto; max-width:none; --gap:1px; }
  .hpbar{ width: calc(var(--cell)*var(--grid-w) + (var(--grid-w) - 1)*var(--gap)); margin:0 0 8px; }
}

/* =========================================================
   DESKTOP/LAPTOP: Equal heights for the three columns
   ========================================================= */
@media (min-width: 901px){
  /* Make the row fill the viewport and let panels stretch to match height */
  .wrap{
    align-items: stretch;
    min-height: calc(100svh - var(--hdr-h) - 24px); /* 24px = .wrap vertical padding (12+12) */
  }
  /* Each main panel fills the row height */
  #hudPanel, .map, #logPanel{ height: 100%; }

  /* Script panel scrolls internally instead of growing taller than others */
  #logPanel{
    display:flex; flex-direction:column; min-height:0;
  }
  .log{
    flex:1; min-height:0; overflow:auto; max-height:unset; /* override earlier max-height */
  }

  /* Optional: allow left HUD to scroll if content exceeds column height */
  #hudPanel{ display:flex; flex-direction:column; overflow:auto; min-height:0; }
}
</style>
</head>

<body>
<header class="appbar">
  <div class="appbar-title">D&D Pixel Crawler</div>
  <div class="appbar-actions">
    <button id="soundBtn" class="btn">ðŸ”Š Sound: On</button>
    <button id="musicBtn" class="btn">ðŸŽµ Music: On</button>
  </div>
</header>

<!-- Top notifications -->
<div id="banners" class="banners" aria-live="polite" aria-atomic="true"></div>

<div class="wrap">
  <!-- LEFT: HUD -->
  <div id="hudPanel" class="panel hud">
    <h3 class="section-title">Hero</h3>
    <div id="stats" class="stats-row"></div>

    <h3 class="section-title" style="margin-top:10px;">Inventory</h3>
    <div id="inventory" class="inv"></div>

    <h3 class="section-title" style="margin-top:10px;">Quests</h3>
    <div id="quests" class="quest-list"></div>

    <div style="margin-top:8px"><button id="codexBtn" class="btn">ðŸ“– Codex</button></div>

    <details class="accordion" style="margin-top:10px">
      <summary>Instructions</summary>
      <div class="accordion-body">
        <strong>Move:</strong> Arrow Keys / WASD, swipe, or D-pad.<br/>
        <strong>E</strong> talk/use â€¢ <strong>Space</strong> pick up â€¢ <strong>F</strong> fight â€¢ <strong>H</strong> heal.<br/>
        Tap a potion in your Bag to heal outside combat.
      </div>
    </details>
  </div>

  <!-- CENTER: MAP -->
  <div class="map" aria-label="Map">
    <div class="grid-wrap">
      <div class="hpbar"><div id="hpfill" class="hpbar-fill"></div><div id="hptext" class="hpbar-text">HP 10/10</div></div>
      <div id="grid" class="grid" aria-label="Dungeon grid"></div>
    </div>
  </div>

  <!-- RIGHT: SCRIPT (and HUD clone for mobile tabs) -->
  <div class="side" id="sideCol">
    <div id="mobileTabs" class="mobile-tabs" role="tablist" aria-label="Panels">
      <button class="tab active" data-tab="log" role="tab" aria-selected="true" aria-controls="logPanel">Script</button>
      <button class="tab" data-tab="bag" role="tab" aria-selected="false" aria-controls="hudPanelSide">Bag</button>
    </div>

    <div id="logPanel" class="panel">
      <h3 id="logTitle" class="section-title">Script</h3>
      <div id="log" class="log"></div>
    </div>

    <!-- Hidden on desktop; shown on mobile via tabs -->
    <div id="hudPanelSide" class="panel hud" style="display:none">
      <h3 class="section-title">Hero</h3>
      <div id="stats_s" class="stats-row"></div>

      <h3 class="section-title" style="margin-top:10px;">Inventory</h3>
      <div id="inventory_s" class="inv"></div>

      <h3 class="section-title" style="margin-top:10px;">Quests</h3>
      <div id="quests_s" class="quest-list"></div>

      <div style="margin-top:8px"><button id="codexBtn_s" class="btn">ðŸ“– Codex</button></div>
    </div>
  </div>

  <!-- D-PAD (used in mobile landscape; hidden otherwise) -->
  <div id="dpad" aria-hidden="true">
    <div class="pad-arrows">
      <div class="d-row"><button class="d-btn" data-a="up" aria-label="Up">â–²</button></div>
      <div class="d-row">
        <button class="d-btn" data-a="left" aria-label="Left">â—€</button>
        <button class="d-btn d-big" data-a="use" aria-label="Use">Use (E)</button>
        <button class="d-btn" data-a="right" aria-label="Right">â–¶</button>
      </div>
      <div class="d-row"><button class="d-btn" data-a="down" aria-label="Down">â–¼</button></div>
    </div>
    <div class="pad-actions">
      <button class="act-btn" data-a="fight">Fight <small>(F)</small></button>
      <button class="act-btn" data-a="pick">Pick Up <small>(Space)</small></button>
      <button class="act-btn" data-a="heal">Heal <small>(H)</small></button>
    </div>
  </div>
</div>

<!-- DIALOG MODAL -->
<div id="dialog" class="overlay" role="dialog" aria-modal="true">
  <div class="card">
    <h2 id="dialog-title">Conversation</h2>
    <div id="dialog-text" class="bubble" style="margin:8px 0"></div>
    <div id="dialog-choices" class="choices"></div>
    <div class="actions"><button id="dialog-leave" class="btn">Close</button></div>
  </div>
</div>

<!-- LEVEL UP MODAL -->
<div id="lvlup" class="overlay" role="dialog" aria-modal="true">
  <div class="card">
    <h2>Level Up!</h2>
    <p id="lvlup-details"></p>
    <div class="actions"><button id="lvlup-continue" class="btn">Continue â†’</button></div>
  </div>
</div>

<!-- Music (YouTube) -->
<div id="yt-player" aria-hidden="true" style="position:absolute;left:-9999px;top:-9999px;width:1px;height:1px"></div>
<script src="https://www.youtube.com/iframe_api"></script>

<script>
/* =========================================================
   UTILITIES & STATE
   ========================================================= */
const W=15,H=13;
const key=(x,y)=>`${x},${y}`;
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
const rand=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const withSign=n=>(n>=0?"+":"")+n;
const escapeHTML=s=>String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
function vib(ms=30){ if(navigator.vibrate) try{navigator.vibrate(ms)}catch(e){} }

const logEl=document.getElementById('log'), logTitle=document.getElementById('logTitle');

const state={
  level:1, hpMax:10, hp:10, ac:12, str:+2, dex:+1, atk:+4,
  pos:{x:2,y:2}, gold:0,
  inventory:[{id:'potion',name:'Healing Potion',qty:1,type:'potion'}],
  codex:[], ally:null,
  musicOn:true, soundOn:true,
  room:'level1', seen:{},
  quests:[{id:'goblin',title:'Defeat the Goblin',status:'active'}],
  monstersDefeated:0
};

/* =========================================================
   ROOMS (two levels)
   ========================================================= */
function level1(){
  const walls=new Set();
  for(let x=0;x<W;x++){walls.add(key(x,0));walls.add(key(x,H-1))}
  for(let y=0;y<H;y++){walls.add(key(0,y));walls.add(key(W-1,y))}
  [[4,2],[5,2],[6,2],[7,2],[7,3],[7,4],[8,5],[2,6],[3,6],[4,7],[5,7],[6,8],[2,9],[3,9],[4,9]]
    .forEach(([x,y])=>walls.add(key(x,y)));
  const doors=new Set([key(W-1,5)]);

  const npcs={
    [key(3,3)]:{
      id:'sage', name:'Sage', portrait:'#7fb7ff',
      script:(say,choose)=>{
        say('Sage: A red fiend lurks east. End it.','dialog');
        choose([
          {label:'Give me a quest', hint:'You look eager.',
            action:()=>say('Sage: Aim true.','dialog')},
          {label:'Whatâ€™s the catch?', hint:'Always a catchâ€¦',
            action:()=>say('Sage: Only glory, and maybe splinters.','dialog')}
        ]);
      }
    }
  };

  const items={
    [key(5,4)]:{
      id:'charm', name:'Sage Charm (+1 attack)', type:'charm',
      onPick:()=>{ state.atk+=1; addCodex('Sage Charm (+1 attack)'); banner('loot','Picked up Sage Charm (+1 attack).'); }
    }
  };

  const monsters={
    [key(12,4)]:{
      id:'goblin', name:'Red Goblin', ac:11, hp:6, atk:+3,
      onDefeat:()=>{
        markQuestDone('goblin'); state.monstersDefeated++;
        banner('combat','The red goblin is no more!');
        if(state.monstersDefeated>=1 && state.level===1) setTimeout(showLevelUp,350);
      }
    }
  };

  return {walls,doors,npcs,items,monsters};
}

function level2(){
  const walls=new Set();
  for(let x=0;x<W;x++){walls.add(key(x,0));walls.add(key(x,H-1))}
  for(let y=0;y<H;y++){walls.add(key(0,y));walls.add(key(W-1,y))}
  [[1,6],[2,6],[3,6],[7,3],[8,3],[9,3],[9,4],[9,5],[4,9],[5,9],[6,9],[10,8]]
    .forEach(([x,y])=>walls.add(key(x,y)));
  const doors=new Set([key(1,5)]);

  const npcs={
    [key(5,5)]:{
      id:'nyx', name:'Stranger', portrait:'#ff9bf3',
      script:(say,choose)=>{
        say('Nyx: Fancy some flanking? I work for half the loot. Deal?','dialog');
        choose([
          {label:'What do you offer?', hint:'+flanking advantage', action:()=>say('Nyx: I distract, you strike. Advantage on attacks.','dialog')},
          {label:'Whatâ€™s the catch?', hint:'Split payment', action:()=>say('Nyx: 50g reward? We split it. You keep the glory.','dialog')},
          {label:'Join me', hint:'Gain advantage; split gold', action:()=>{state.ally='nyx'; banner('dialog','Nyx joins! You gain flanking advantage.');}},
          {label:'No thanks', hint:'Solo hero time', action:()=>say('Nyx: Suit yourself, lone wolf.','dialog')}
        ]);
      }
    }
  };

  const items={ [key(9,6)]:{ id:'potion', name:'Healing Potion', type:'potion' } };
  const monsters={ [key(11,6)]:{ id:'ogre', name:'Grumpy Ogre', ac:13, hp:10, atk:+4, onDefeat:()=>banner('combat','Ogre down! Nyx: â€œTold you teamwork slaps.â€') } };

  return {walls,doors,npcs,items,monsters};
}

const rooms={ level1:level1(), level2:level2() };

/* =========================================================
   RENDERING
   ========================================================= */
const gridEl=document.getElementById('grid'),
      hpFill=document.getElementById('hpfill'),
      hpText=document.getElementById('hptext');

function ensureSeenSet(){ if(!state.seen[state.room]) state.seen[state.room]=new Set(); }
function inBounds(x,y){ return x>=0 && y>=0 && x<W && y<H; }
function isWall(x,y){ return rooms[state.room].walls.has(key(x,y)); }
function isDoor(x,y){ return rooms[state.room].doors.has(key(x,y)); }
function entityAt(x,y){
  const R=rooms[state.room], k=key(x,y);
  if(R.monsters[k]) return {type:'monster',data:R.monsters[k]};
  if(R.npcs[k])     return {type:'npc',data:R.npcs[k]};
  if(R.items[k])    return {type:'item',data:R.items[k]};
  return null;
}
function reveal(x,y){
  ensureSeenSet(); const seen=state.seen[state.room];
  for(let yy=y-2;yy<=y+2;yy++) for(let xx=x-2;xx<=x+2;xx++) if(inBounds(xx,yy)) seen.add(key(xx,yy));
}

function render(){
  ensureSeenSet();
  gridEl.innerHTML='';
  const R=rooms[state.room];
  for(let y=0;y<H;y++){
    for(let x=0;x<W;x++){
      const c=document.createElement('div');
      c.className='cell '+(isWall(x,y)?'wall':'floor');
      const k=key(x,y);
      const e=entityAt(x,y);
      if(e){
        if(e.type==='npc') c.classList.add('npc');
        if(e.type==='item') c.classList.add('item');
        if(e.type==='monster') c.classList.add('monster');
      }
      if(isDoor(x,y)) c.classList.add('door');
      if(state.pos.x===x && state.pos.y===y) c.classList.add('player','cursor');

      const seen=state.seen[state.room];
      const vis=seen.has(k);
      if(!vis) c.classList.add('fog-unseen');
      else if(!(state.pos.x===x && state.pos.y===y)) c.classList.add('fog-seen');

      gridEl.appendChild(c);
    }
  }
  updateHP(); renderHUD(); renderQuests();
}

function updateHP(){
  const p = Math.max(0, Math.min(1, state.hp/state.hpMax));
  hpFill.style.width = (p*100) + '%';
  hpFill.style.background = p < .34 ? '#c0392b' : 'linear-gradient(90deg,#28c76f,#24a36f)';
  hpText.textContent = `HP ${state.hp}/${state.hpMax}`;
}

/* =========================================================
   HUD (and HUD clone)
   ========================================================= */
function statsHTML(){
  return `
    <span class="stat-chip"><b>LV</b> ${state.level}</span>
    <span class="stat-chip"><b>HP</b> ${state.hp}/${state.hpMax}</span>
    <span class="stat-chip"><b>AC</b> ${state.ac}</span>
    <span class="stat-chip"><b>STR</b> ${withSign(state.str)}</span>
    <span class="stat-chip"><b>DEX</b> ${withSign(state.dex)}</span>
    <span class="stat-chip"><b>ATK</b> ${withSign(state.atk)}</span>
  `;
}
function renderHUD(){
  document.querySelectorAll('#stats,#stats_s').forEach(el=>el.innerHTML=statsHTML());

  ['inventory','inventory_s'].forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    el.innerHTML='';
    const gold=document.createElement('span'); gold.className='tag gold'; gold.innerHTML=`ðŸŸ¡ ${state.gold}g`; el.appendChild(gold);
    for(const it of state.inventory){
      const chip=document.createElement('button');
      chip.className='tag inv-item';
      chip.innerHTML = `${escapeHTML(it.name)}${it.qty>1?` Ã—${it.qty}`:''}`;
      if(it.type==='potion') chip.title='Use potion';
      if(it.type==='potion') chip.addEventListener('click',usePotion);
      el.appendChild(chip);
    }
  });
}
function renderQuests(){
  ['quests','quests_s'].forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    el.innerHTML='';
    for(const q of state.quests){
      const row=document.createElement('div'); row.className=`quest ${q.status}`;
      const dot=document.createElement('span'); dot.className='qdot';
      const title=document.createElement('span'); title.className='qtitle'; title.textContent=q.title;
      const st=document.createElement('span'); st.className='qstatus'; st.textContent=q.status;
      row.append(dot,title,st); el.appendChild(row);
    }
  });
}
function markQuestDone(id){ const q=state.quests.find(q=>q.id===id); if(q){ q.status='completed'; renderQuests(); } }

/* =========================================================
   SCRIPT LOG + BANNERS
   ========================================================= */
function logEntry(type,text,portrait){
  const e=document.createElement('div'); e.className=`entry ${type}`;
  const p=document.createElement('div'); p.className='portrait'; if(portrait) p.style.background=portrait;
  const b=document.createElement('div'); b.className='bubble'; b.textContent=text;
  e.append(p,b);
  if(logEl.firstChild) logEl.insertBefore(e, logEl.firstChild); else logEl.appendChild(e);
  logTitle.classList.remove('pulse'); void logTitle.offsetWidth; logTitle.classList.add('pulse');
}
function banner(type,text){
  const host=document.getElementById('banners');
  const b=document.createElement('div'); b.className=`banner ${type}`;
  b.innerHTML=`<div class="dot"></div><div class="txt">${escapeHTML(text)}</div><button class="close">âœ•</button>`;
  b.querySelector('.close').onclick=()=>b.remove();
  host.appendChild(b); setTimeout(()=>b.remove(), 4500);
}

/* =========================================================
   DIALOG SYSTEM
   ========================================================= */
const dialogEl=document.getElementById('dialog'),
      dialogText=document.getElementById('dialog-text'),
      dialogChoices=document.getElementById('dialog-choices');
document.getElementById('dialog-leave').onclick=()=>dialogEl.classList.remove('show');

function openDialog(title,text){
  document.getElementById('dialog-title').textContent=title||'Conversation';
  dialogText.textContent=text||'';
  dialogChoices.innerHTML='';
  dialogEl.classList.add('show');
}
function addChoice(label,hint,cb){
  const b=document.createElement('button'); b.className='choice-btn';
  b.textContent=label; if(hint) b.title=hint; b.onclick=()=>cb();
  dialogChoices.appendChild(b);
}

/* =========================================================
   ACTIONS
   ========================================================= */
function tryMove(dx,dy){
  const nx=clamp(state.pos.x+dx,0,W-1), ny=clamp(state.pos.y+dy,0,H-1);
  if(isWall(nx,ny)){ logEntry('system','You hit a wall. Your health remains the same, but your ego takes a hit.'); return; }
  state.pos.x=nx; state.pos.y=ny; vib(10); reveal(nx,ny);
  if(isDoor(nx,ny)) banner('dialog','You stand by a door. Press E to use it.');
  render();
}
function tryUse(){
  const {x,y}=state.pos;
  // Doors: current or adjacent
  if([key(x,y),key(x+1,y),key(x-1,y),key(x,y+1),key(x,y-1)].some(k=>rooms[state.room].doors.has(k))){
    if(state.room==='level1'){
      state.room='level2';
      if(!state.seen[state.room]) state.seen[state.room]=new Set();
      banner('system','You step through the doorâ€¦'); logEntry('system','You enter a new chamber.');
      state.pos={x:1,y:5}; reveal(state.pos.x,state.pos.y); render(); return;
    } else {
      banner('system','The door is stubborn. It probably leads back.');
    }
  }
  // NPC talk (self or adjacent)
  for(const [cx,cy] of [[x,y],[x+1,y],[x-1,y],[x,y+1],[x,y-1]]){
    const npc=rooms[state.room].npcs[key(cx,cy)];
    if(npc){
      openDialog(npc.name,'');
      const say=(t,type='dialog')=>{ dialogText.textContent=t; logEntry(type,t,npc.portrait); };
      const choose=(arr)=>{ dialogChoices.innerHTML=''; arr.forEach(o=>addChoice(o.label,o.hint,()=>o.action())); };
      npc.script(say,choose);
      return;
    }
  }
  logEntry('system','There is nothing obvious to use here.');
}
function tryPick(){
  const k=key(state.pos.x,state.pos.y);
  const it=rooms[state.room].items[k];
  if(!it){ logEntry('system','You scoop up a handful of air. Tastes like pixels.'); return; }
  delete rooms[state.room].items[k];
  const ex=state.inventory.find(i=>i.id===it.id);
  if(ex) ex.qty=(ex.qty||1)+1; else { it.qty=1; state.inventory.push(it); }
  if(typeof it.onPick==='function') it.onPick(); else banner('loot',`Picked up ${it.name}.`);
  renderHUD(); render();
}
function rollD20(){ return Math.floor(Math.random()*20)+1; }
function tryFight(){
  const adj=[[0,0],[1,0],[-1,0],[0,1],[0,-1]].map(([dx,dy])=>({x:state.pos.x+dx,y:state.pos.y+dy}));
  let targetKey,target; for(const p of adj){const m=rooms[state.room].monsters[key(p.x,p.y)]; if(m){ targetKey=key(p.x,p.y); target=m; break; }}
  if(!target){ logEntry('combat','You swing your sword and slice nothing but air.'); banner('combat','No monsters in range.'); return; }

  const r1=rollD20(), r2=state.ally?rollD20():-1;
  const r=state.ally?Math.max(r1,r2):r1; const toHit=r+state.atk;
  if(r===20){ target.hp=0; logEntry('combat',`CRIT! d20=${r}. You obliterate the ${target.name}.`); }
  else if(toHit>=target.ac){ target.hp-=rand(2,5)+state.str; logEntry('combat',`Hit! d20=${r} + ATK ${state.atk} = ${toHit} vs AC ${target.ac}.`); }
  else { logEntry('combat',`Miss! d20=${r} + ATK ${state.atk} = ${toHit} < AC ${target.ac}.`); }

  if(target.hp<=0){
    delete rooms[state.room].monsters[targetKey];
    if(typeof target.onDefeat==='function') target.onDefeat();
    state.gold+=10; banner('loot','You loot 10g.'); renderHUD();
  } else {
    const mr=rollD20(), mh=mr+target.atk;
    if(mr===20 || mh>=state.ac){
      const dmg=rand(1,4)+2; state.hp=Math.max(0,state.hp-dmg);
      logEntry('combat',`The ${target.name} hits you for ${dmg}.`);
      if(state.hp<=0){
        banner('combat','You fallâ€¦ but the autosave fairy rewinds time.');
        state.hp=Math.ceil(state.hpMax/2); state.pos={x:2,y:2}; reveal(state.pos.x,state.pos.y);
      }
    } else {
      logEntry('combat',`The ${target.name} whiffs spectacularly. Their ego takes a hit.`);
    }
  }
  render();
}
function usePotion(){
  const p=state.inventory.find(i=>i.id==='potion'&&i.qty>0);
  if(!p){ banner('system','No potions.'); return; }
  if(state.hp>=state.hpMax){ banner('system','Already at full health.'); return; }
  p.qty--; if(p.qty<=0) state.inventory=state.inventory.filter(i=>i!==p);
  const heal=5; state.hp=Math.min(state.hpMax,state.hp+heal);
  banner('loot',`You sip a questionable brew: +${heal} HP.`); renderHUD(); render();
}

/* =========================================================
   LEVEL UP
   ========================================================= */
function showLevelUp(){
  state.level+=1; state.hpMax+=5; state.ac+=1; state.hp=state.hpMax;
  document.getElementById('lvlup-details').textContent=`You reached level ${state.level}! +5 HP, +1 AC.`;
  document.getElementById('lvlup').classList.add('show');
}
document.getElementById('lvlup-continue').onclick=()=>{
  document.getElementById('lvlup').classList.remove('show');
  state.room='level2'; state.pos={x:1,y:5}; reveal(state.pos.x,state.pos.y); banner('system','Level 2 unlocked.'); render();
};

/* =========================================================
   CODEX
   ========================================================= */
function addCodex(e){ state.codex.push(e); logEntry('loot',`Codex updated: ${e}`); }
document.getElementById('codexBtn').onclick=()=>{ openDialog('Codex', (state.codex.length? state.codex.join('\nâ€¢ '):'So empty. Talk to people, pick up shiny things.')); addChoice('Close','',()=>dialogEl.classList.remove('show')); };
document.getElementById('codexBtn_s').onclick=()=>document.getElementById('codexBtn').click();

/* =========================================================
   INPUTS
   ========================================================= */
function bindInputs(){
  window.addEventListener('keydown',e=>{
    if(document.getElementById('dialog').classList.contains('show')) return;
    switch(e.key){
      case'ArrowUp':case'w':case'W': tryMove(0,-1); break;
      case'ArrowDown':case's':case'S': tryMove(0, 1); break;
      case'ArrowLeft':case'a':case'A': tryMove(-1,0); break;
      case'ArrowRight':case'd':case'D': tryMove(1, 0); break;
      case'e':case'E': tryUse(); break;
      case' ': tryPick(); e.preventDefault(); break;
      case'f':case'F': tryFight(); break;
      case'h':case'H': usePotion(); break;
    }
  });
  document.getElementById('dpad').addEventListener('click',e=>{
    const b=e.target.closest('[data-a]'); if(!b) return;
    const a=b.dataset.a;
    if(a==='up') tryMove(0,-1);
    else if(a==='down') tryMove(0,1);
    else if(a==='left') tryMove(-1,0);
    else if(a==='right') tryMove(1,0);
    else if(a==='use') tryUse();
    else if(a==='fight') tryFight();
    else if(a==='pick') tryPick();
    else if(a==='heal') usePotion();
  });
}

/* =========================================================
   MOBILE TABS
   ========================================================= */
function initMobileTabs(){
  const tabs=document.getElementById('mobileTabs');
  function setTab(tab){
    const log=document.getElementById('logPanel');
    const bag=document.getElementById('hudPanelSide');
    const portraitSmall = window.matchMedia('(max-width: 900px) and (orientation: portrait)').matches;
    if(portraitSmall){
      bag.style.display = (tab==='bag') ? 'block' : 'none';
      log.style.display = (tab==='log') ? 'block' : 'none';
    }else{
      bag.style.display = (tab==='bag') ? 'block' : 'none';
      log.style.display = (tab==='log') ? 'block' : 'none';
    }
    [...tabs.querySelectorAll('.tab')].forEach(b=>{
      const on=b.dataset.tab===tab;
      b.classList.toggle('active', on);
      b.setAttribute('aria-selected', on?'true':'false');
    });
  }
  tabs.addEventListener('click',e=>{
    const b=e.target.closest('.tab'); if(b) setTab(b.dataset.tab);
  });
  window.addEventListener('resize',()=>setTab('log'),{passive:true});
  setTab('log');
}

/* =========================================================
   MUSIC / SOUND
   ========================================================= */
let ytPlayer;
window.onYouTubeIframeAPIReady = function(){
  ytPlayer = new YT.Player('yt-player',{
    videoId:'wScEFaoqwPM',
    playerVars:{ autoplay:1, loop:1, playlist:'wScEFaoqwPM' },
    events:{ onReady:e=>{ state.musicOn?e.target.playVideo():e.target.pauseVideo(); } }
  });
};
document.getElementById('musicBtn').onclick=()=>{
  state.musicOn=!state.musicOn;
  document.getElementById('musicBtn').textContent = state.musicOn ? 'ðŸŽµ Music: On' : 'ðŸŽµ Music: Off';
  if(ytPlayer && ytPlayer.getPlayerState){ state.musicOn?ytPlayer.playVideo():ytPlayer.pauseVideo(); }
};
document.getElementById('soundBtn').onclick=()=>{
  state.soundOn=!state.soundOn;
  document.getElementById('soundBtn').textContent = state.soundOn ? 'ðŸ”Š Sound: On' : 'ðŸ”ˆ Sound: Off';
};

/* =========================================================
   RESPONSIVE SIZING â€” container-aware fitScale()
   ========================================================= */
function fitScale(){
  const root = document.documentElement;
  const appbar = document.querySelector('.appbar');
  const wrap = document.querySelector('.wrap');

  const hpReserve = 22;        // room for HP bar
  const gap = 1;               // grid gutters at small scales

  const isLandscapePhone = window.matchMedia('(orientation: landscape) and (max-height: 500px)').matches;

  if (isLandscapePhone){
    /* ===== Phones Landscape: Map | Side | D-pad ===== */
    const vw = Math.min(window.innerWidth, document.documentElement.clientWidth);
    const vh = window.innerHeight;
    const headerH = appbar?.getBoundingClientRect().height || 56;

    const sideW = Math.max(260, Math.round(vw * 0.34));   // middle column
    const dpadW = Math.max(190, Math.round(vw * 0.26));   // right column
    const mapAvailW = vw - sideW - dpadW - 16;            // remaining for map (with a small gutter)
    const mapAvailH = vh - headerH - 10;

    const cellByW = Math.floor((mapAvailW - (W-1)*gap) / W);
    const cellByH = Math.floor((mapAvailH - hpReserve - (H-1)*gap) / H);
    const cell = Math.max(10, Math.min(64, Math.min(cellByW, cellByH)));

    root.style.setProperty('--gap', `${gap}px`);
    root.style.setProperty('--scale','1');
    root.style.setProperty('--cell', `${cell}px`);
    root.style.setProperty('--mapW', `${cell*W + gap*(W-1)}px`);
    root.style.setProperty('--sideW', `${sideW}px`);
    root.style.setProperty('--dpadW', `${dpadW}px`);
    return;
  }

  // ===== Desktop & portrait: compute from the actual map column width/height =====
  root.style.removeProperty('--mapW');
  root.style.removeProperty('--sideW');
  root.style.removeProperty('--dpadW');

  const mapOuter = document.querySelector('.map');
  const cs = getComputedStyle(mapOuter);
  const padX = parseFloat(cs.paddingLeft) + parseFloat(cs.paddingRight);
  const borderX = parseFloat(cs.borderLeftWidth) + parseFloat(cs.borderRightWidth);
  const mapAvailW = Math.max(120, mapOuter.clientWidth - padX - borderX);

  const vh = window.innerHeight;
  const headerH = appbar?.getBoundingClientRect().height || 56;
  const wrapCS = getComputedStyle(wrap);
  const padY = parseFloat(wrapCS.paddingTop) + parseFloat(wrapCS.paddingBottom);
  const mapAvailH = Math.max(160, vh - headerH - padY);

  const cellByW = Math.floor((mapAvailW - (W-1)*gap) / W);
  const cellByH = Math.floor((mapAvailH - hpReserve - (H-1)*gap) / H);
  const cell = Math.max(12, Math.min(64, Math.min(cellByW, cellByH)));

  root.style.setProperty('--gap', `${gap}px`);
  root.style.setProperty('--scale','1');      // drive size via --cell
  root.style.setProperty('--cell', `${cell}px`);
}

/* Listeners so it stays dynamic */
window.addEventListener('resize', fitScale, {passive:true});
window.addEventListener('orientationchange', ()=>setTimeout(fitScale, 60), {passive:true});
const __ro = new ResizeObserver(()=>fitScale());
__ro.observe(document.body);

/* =========================================================
   BOOT
   ========================================================= */
function bootstrap(){
  ensureSeenSet(); reveal(state.pos.x,state.pos.y);
  bindInputs(); initMobileTabs();
  render(); renderHUD();
  fitScale();

  // Starter script lines
  logEntry('dialog','Sage: A red fiend lurks east. End it.','#7fb7ff');
  logEntry('dialog','You: Give me a quest','#7fb7ff');
  banner('dialog','Welcome! Use arrows/WASD or D-pad. Press E near NPCs/doors.');
}
bootstrap();
</script>
</body>
</html>
